<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beast Earn - Aviator Game</title>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f0f0f0;
            overflow-x: hidden; /* Prevent horizontal scroll on small screens */
        }
        @keyframes pulse-result {
            0% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pulse-result {
            animation: pulse-result 0.5s ease-out forwards;
        }
        /* Adjusted animation for the rocket to give a more dynamic feel */
        @keyframes fly {
            0% { transform: translateX(-50%) translateY(50%) scale(1); opacity: 0.5; }
            25% { transform: translateX(0%) translateY(0%) scale(1.1); opacity: 0.7; }
            50% { transform: translateX(50%) translateY(-50%) scale(1.2); opacity: 1; }
            75% { transform: translateX(100%) translateY(-25%) scale(1.1); opacity: 0.7; }
            100% { transform: translateX(150%) translateY(0%) scale(1); opacity: 0.5; }
        }
        .animate-fly {
            animation: fly 2s ease-in-out infinite alternate; /* Looping animation */
        }
        /* Mines Game specific styles */
        .mines-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            width: 100%;
            max-width: 320px; /* Adjust grid size */
            margin: 0 auto;
        }
        .mine-box {
            width: 60px; /* Fixed size for boxes */
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            background-color: #d97706; /* unopened - orange-700 */
            border: 2px solid #ea580c; /* orange-800 */
            color: #fee2e2; /* red-100 */
        }
        .mine-box:hover:not(.safe):not(.mine):not(.disabled-box) {
            transform: scale(1.05);
            background-color: #f97316; /* orange-500 */
        }
        .mine-box.safe {
            background-color: #ef4444; /* Red for safe */
            color: white;
            border-color: #dc2626;
        }
        .mine-box.mine {
            background-color: #1f2937; /* Dark gray for mine */
            color: white;
            border-color: #374151;
        }
        .mine-box.safe_revealed {
            background-color: #f97316; /* Orange for revealed safe (unopened) */
            color: white;
            border-color: #ea580c;
        }
        .mine-box.disabled-box {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .mine-box img {
            width: 80%; /* Make images fit inside the box */
            height: 80%;
            object-fit: contain;
        }

        /* Aviator graph background styling (replaces video) */
        .aviator-graph-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio (divide height by width, 9/16 = 0.5625) */
            background-color: black; /* Black background for the graph */
            border-radius: 8px;
            overflow: hidden; /* Ensure content stays within borders */
        }
        .aviator-graph-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block; /* Remove extra space below canvas */
        }

        /* General responsiveness for max-w-md containers */
        .max-w-md-responsive {
            max-width: 100%; /* Default to full width on small screens */
        }

        @media (min-width: 768px) { /* Adjust breakpoint as needed for tablet/desktop */
            .max-w-md-responsive {
                max-width: 48rem; /* Equivalent to max-w-md in Tailwind, approx 768px */
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCKpMkgWDuCJvB0HCZpA6O5yqX3LGqJdk0",
            authDomain: "beast-earn-b4ea3.firebaseapp.com",
            projectId: "beast-earn-b4ea3",
            storageBucket: "beast-earn-b4ea3.firebasestorage.app",
            messagingSenderId: "638180528781",
            appId: "1:638180528781:web:29de48a20106eb470d48c4"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Inlined SVG for Lucide icons for minimal requests
        const ArrowLeft = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>);
        const Coins = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-coins"><circle cx="8" cy="8" r="6"/><path d="M18.7 10.7H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H9.3a2 2 0 0 1-2-2V13a2 2 0 0 1 2-2h1.3"/><path d="M10 16H8"/></svg>);
        const TrendingUp = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-trending-up"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>);
        const History = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucude-history"><path d="M12 8v4l3 3"/><path d="M17.8 6.2c.7 5.1-1.6 9.8-6.1 11.3a5.5 5.5 0 0 1-7.8-7.6 5.5 5.5 0 0 1 7.6-7.8l1.6 1.6"/></svg>);
        const Gamepad = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-gamepad"><path d="M6 12H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-2"/><path d="M12 12v6a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-6"/><path d="M12 12H8a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h4"/></svg>);
        const Rocket = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-rocket"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5L2 22c0 0.5 0.5 1 1 1h.5c0 0-3-1.5-2.5-3.5C3.5 16.5 6 15 6 15l-1.5 1.5z"/><path d="M10 15h4l-1 6H9l1-6z"/><path d="M17.7 9.3l-1.3-1.3c-0.2-0.2-0.5-0.3-0.7-0.3c-0.3 0-0.5 0.1-0.7 0.3l-1.3 1.3c-0.4 0.4-0.4 1 0 1.4l1.3 1.3c0.2 0.2 0.5 0.3 0.7 0.3c0.3 0 0.5-0.1 0.7-0.3l1.3-1.3c0.4-0.4 0.4-1 0-1.4z"/><path d="M16 21v-4l-1.5-1.5"/><path d="M13 14V3l3 3l-3 3"/><path d="M15 12h5.5c.5 0 1 .5 1 1v.5c0 0-1.5 3-3.5 2.5S15 12 15 12z"/></svg>);
        const Bomb = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-bomb"><circle cx="12" cy="12" r="10"/><path d="m15.5 9.5-3 3-3-3"/><path d="m8.5 14.5 3-3 3 3"/></svg>);
        const Sparkles = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-sparkles"><path d="M12 20V10"/><path d="M19 12H5"/><path d="m12 21.5 3.5 2.5L12 17l-3.5 2.5z"/><path d="m22 2-2.5 2.5L17 2l2.5-2.5z"/><path d="m2 2 2.5 2.5L7 2l-2.5-2.5z"/></svg>);


        // --- Auth Components ---
        const LoginPage = ({ setAuthenticated, navigateToRegister }) => {
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [error, setError] = React.useState('');

            const handleLogin = async () => {
                setError('');
                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    setAuthenticated(true);
                } catch (error) {
                    setError(error.message);
                }
            };

            return (
                <div className="max-w-md mx-auto bg-gradient-to-b from-orange-400 to-red-600 min-h-screen text-white flex flex-col items-center justify-center p-4">
                    <h1 className="text-4xl font-extrabold mb-8 text-yellow-300 drop-shadow-lg">Beast Earn</h1>
                    <h2 className="text-3xl font-bold mb-6">Login</h2>
                    <div className="bg-white bg-opacity-20 rounded-lg p-8 w-full max-w-sm">
                        <div className="mb-4">
                            <label htmlFor="email" className="block text-sm font-semibold mb-2">Email</label>
                            <input
                                id="email"
                                type="email"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                className="w-full p-3 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-300"
                                placeholder="Enter your email"
                            />
                        </div>
                        <div className="mb-6">
                            <label htmlFor="password" className="block text-sm font-semibold mb-2">Password</label>
                            <input
                                id="password"
                                type="password"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                className="w-full p-3 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-300"
                                placeholder="Enter your password"
                            />
                        </div>
                        {error && <p className="text-yellow-200 text-sm mb-4">{error}</p>}
                        <button
                            onClick={handleLogin}
                            className="w-full bg-yellow-400 py-3 rounded-lg font-bold text-red-800 hover:bg-yellow-500 transition-colors mb-4"
                        >
                            Login
                        </button>
                        <p className="text-center text-sm opacity-80">
                            Don't have an account? <button onClick={navigateToRegister} className="text-yellow-300 font-semibold hover:underline">Register here</button>
                        </p>
                    </div>
                </div>
            );
        };

        const RegisterPage = ({ setAuthenticated, navigateToLogin }) => {
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [confirmPassword, setConfirmPassword] = React.useState('');
            const [error, setError] = React.useState('');
            const [loading, setLoading] = React.useState(false);

            const handleRegister = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);

                if (!email || !password || !confirmPassword) {
                    setError('All fields are required');
                    setLoading(false);
                    return;
                }

                if (password !== confirmPassword) {
                    setError('Passwords do not match');
                    setLoading(false);
                    return;
                }

                if (password.length < 6) {
                    setError('Password must be at least 6 characters long');
                    setLoading(false);
                    return;
                }

                try {
                    // Create user with email and password
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;

                    // Create initial user document in Firestore
                    await db.collection('users').doc(user.uid).set({
                        email: user.email,
                        balance: 0,
                        gameHistory: [],
                        depositHistory: [],
                        withdrawHistory: [],
                        createdAt: new Date().toISOString()
                    });

                    setAuthenticated(true);
                } catch (error) {
                    console.error("Registration error:", error);
                    setError(error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="max-w-md mx-auto bg-gradient-to-b from-orange-400 to-red-600 min-h-screen text-white flex flex-col items-center justify-center p-4">
                    <h1 className="text-4xl font-extrabold mb-8 text-yellow-300 drop-shadow-lg">Beast Earn</h1>
                    <h2 className="text-3xl font-bold mb-6">Register</h2>
                    <div className="bg-white bg-opacity-20 rounded-lg p-8 w-full max-w-sm">
                        <div className="mb-4">
                            <label htmlFor="reg-email" className="block text-sm font-semibold mb-2">Email</label>
                            <input
                                id="reg-email"
                                type="email"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                className="w-full p-3 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-300"
                                placeholder="Enter your email"
                            />
                        </div>
                        <div className="mb-4">
                            <label htmlFor="reg-password" className="block text-sm font-semibold mb-2">Password</label>
                            <input
                                id="reg-password"
                                type="password"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                className="w-full p-3 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-300"
                                placeholder="Create a password"
                            />
                        </div>
                        <div className="mb-6">
                            <label htmlFor="confirm-password" className="block text-sm font-semibold mb-2">Confirm Password</label>
                            <input
                                id="confirm-password"
                                type="password"
                                value={confirmPassword}
                                onChange={(e) => setConfirmPassword(e.target.value)}
                                className="w-full p-3 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-300"
                                placeholder="Confirm your password"
                            />
                        </div>
                        {error && <p className="text-yellow-200 text-sm mb-4">{error}</p>}
                        <button
                            onClick={handleRegister}
                            className="w-full bg-yellow-400 py-3 rounded-lg font-bold text-red-800 hover:bg-yellow-500 transition-colors mb-4"
                        >
                            Register
                        </button>
                        <p className="text-center text-sm opacity-80">
                            Already have an account? <button onClick={navigateToLogin} className="text-yellow-300 font-semibold hover:underline">Login here</button>
                        </p>
                    </div>
                </div>
            );
        };


        // --- History Page Component ---
        const HistoryPage = ({ navigateTo, gameHistory, depositHistory, withdrawHistory, initialTab = 'game' }) => {
            const [activeTab, setActiveTab] = React.useState(initialTab); // 'game', 'deposit', 'withdraw'

            React.useEffect(() => {
                setActiveTab(initialTab);
            }, [initialTab]);

            const getResultColor = (result) => {
                if (result === 0) return 'bg-gradient-to-r from-red-500 to-purple-500';
                if (result === 5) return 'bg-gradient-to-r from-green-500 to-purple-500';
                if (result % 2 === 0) return 'bg-red-500';
                return 'bg-green-500';
            };

            return (
                <div className="max-w-md mx-auto bg-gradient-to-b from-orange-400 to-red-600 min-h-screen text-white p-4">
                    <div className="flex items-center gap-2 mb-6">
                        <button onClick={() => navigateTo('gameSelection')} className="p-2 rounded-full bg-white bg-opacity-30">
                            <ArrowLeft className="w-5 h-5 text-white" />
                        </button>
                        <h2 className="text-xl font-bold">Transaction History</h2>
                    </div>

                    <div className="flex bg-white bg-opacity-20 rounded-lg mb-4 p-1">
                        <button
                            className={`flex-1 py-2 text-sm font-semibold rounded-md ${activeTab === 'game' ? 'bg-white text-orange-700' : 'text-white'}`}
                            onClick={() => setActiveTab('game')}
                        >
                            Game
                        </button>
                        <button
                            className={`flex-1 py-2 text-sm font-semibold rounded-md ${activeTab === 'deposit' ? 'bg-white text-orange-700' : 'text-white'}`}
                            onClick={() => setActiveTab('deposit')}
                        >
                            Deposit
                        </button>
                        <button
                            className={`flex-1 py-2 text-sm font-semibold rounded-md ${activeTab === 'withdraw' ? 'bg-white text-orange-700' : 'text-white'}`}
                            onClick={() => setActiveTab('withdraw')}
                        >
                            Withdraw
                        </button>
                    </div>

                    <div className="bg-white bg-opacity-10 rounded-lg p-4">
                        {activeTab === 'game' && (
                            <div>
                                <h3 className="text-lg font-semibold mb-3">Game Play History</h3>
                                {gameHistory.length === 0 ? (
                                    <p className="text-center opacity-70">No game history yet.</p>
                                ) : (
                                    <div className="space-y-3 max-h-96 overflow-y-auto">
                                        {gameHistory.map((game, index) => (
                                            <div key={game.period} className="flex items-center justify-between bg-white bg-opacity-10 rounded-lg p-3">
                                                <div className="text-xs">{game.period}</div>
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold ${getResultColor(game.result)}`}>
                                                    {game.result}
                                                </div>
                                                <div className="text-sm">
                                                    {game.color ? (game.color.charAt(0).toUpperCase() + game.color.slice(1)) : ''} ({game.size})
                                                </div>
                                                {game.betOutcome && (
                                                    <div className={`font-bold ${game.betOutcome.type === 'win' ? 'text-green-300' : 'text-red-300'}`}>
                                                        {game.betOutcome.type === 'win' ? '+' : '-'}₹{game.betOutcome.amount.toFixed(2)}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'deposit' && (
                            <div>
                                <h3 className="text-lg font-semibold mb-3">Deposit History</h3>
                                {depositHistory.length === 0 ? (
                                    <p className="text-center opacity-70">No deposit history yet.</p>
                                ) : (
                                    <div className="space-y-3 max-h-96 overflow-y-auto">
                                        {depositHistory.map((deposit, index) => (
                                            <div key={index} className="flex items-center justify-between bg-white bg-opacity-10 rounded-lg p-3">
                                                <div className="text-sm font-bold text-green-300">+ ₹{deposit.amount.toFixed(2)}</div>
                                                <div className="text-xs opacity-80 truncate ml-2">{deposit.utr}</div>
                                                <div className="text-xs opacity-70">{new Date(deposit.timestamp).toLocaleString()}</div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'withdraw' && (
                            <div>
                                <h3 className="text-lg font-semibold mb-3">Withdrawal History</h3>
                                {withdrawHistory.length === 0 ? (
                                    <p className="text-center opacity-70">No withdrawal history yet.</p>
                                ) : (
                                    <div className="space-y-3 max-h-96 overflow-y-auto">
                                        {withdrawHistory.map((withdraw, index) => (
                                            <div key={index} className="flex items-center justify-between bg-white bg-opacity-10 rounded-lg p-3">
                                                <div className="text-sm font-bold text-red-300">- ₹{withdraw.amount.toFixed(2)}</div>
                                                <div className="text-xs opacity-80 truncate ml-2">{withdraw.upiId}</div>
                                                <div className="text-xs opacity-70">{new Date(withdraw.timestamp).toLocaleString()}</div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };


        // --- Deposit Page Component ---
        const DepositPage = ({ setBalance, navigateTo, addDepositToHistory }) => {
            const [depositAmount, setDepositAmount] = React.useState('');
            const [utrNumber, setUtrNumber] = React.useState('');
            const [paymentScreenshot, setPaymentScreenshot] = React.useState(null); // New state for screenshot file
            const [message, setMessage] = React.useState(null);
            const upiId = "8979873681@mbk";
            const upiQrCodeUrl = "qr.png";

            const MIN_DEPOSIT_AMOUNT = 10; // Defined minimum deposit amount


            const generateUpiLink = () => {
                const amount = parseFloat(depositAmount);
                if (isNaN(amount) || amount < MIN_DEPOSIT_AMOUNT) { // Changed condition
                    setMessage({ type: 'error', text: `Please enter a valid amount (minimum ₹${MIN_DEPOSIT_AMOUNT}).` });
                    return null;
                }
                const encodedUpiId = encodeURIComponent(upiId);
                const encodedAmount = encodeURIComponent(amount.toFixed(2));
                const encodedPayeeName = encodeURIComponent("Beast Earn Deposit");
                const encodedTransactionRef = encodeURIComponent(`BEASTEARN_${Date.now()}`);
                const encodedNote = encodeURIComponent("Deposit for Color Prediction Game");

                return `upi://pay?pa=${encodedUpiId}&pn=${encodedPayeeName}&mc=0000&tid=${encodedTransactionRef}&tr=${encodedTransactionRef}&am=${encodedAmount}&cu=INR&tn=${encodedNote}`;
            };

            const handlePayRedirect = () => {
                const upiLink = generateUpiLink();
                if (upiLink) {
                    window.location.href = upiLink;
                    setMessage({ type: 'info', text: 'Redirecting to UPI app... Please complete payment there.' });
                }
            };

            const handleManualConfirmation = () => {
                const amount = parseFloat(depositAmount);
                setMessage(null); // Clear previous messages

                if (isNaN(amount) || amount < MIN_DEPOSIT_AMOUNT) { // Changed condition
                     setMessage({ type: 'error', text: `Please enter a valid amount (minimum ₹${MIN_DEPOSIT_AMOUNT}).` });
                     return;
                }
                if (!utrNumber || utrNumber.length < 12) {
                    setMessage({ type: 'error', text: 'Please enter a valid UTR/Transaction ID (min 12 characters).' });
                    return;
                }
                // New check: Ensure screenshot is submitted
                if (!paymentScreenshot) {
                    setMessage({ type: 'error', text: 'Please submit payment screenshot.' });
                    return;
                }

                setBalance(prev => prev + amount);
                addDepositToHistory({
                    amount: amount,
                    utr: utrNumber,
                    timestamp: new Date().toISOString()
                });
                setMessage({ type: 'success', text: `₹${amount.toFixed(2)} added to your balance with UTR: ${utrNumber}! (Manual confirmation)` });
                setDepositAmount('');
                setUtrNumber('');
                setPaymentScreenshot(null); // Clear selected screenshot
                // Note: The screenshot file itself is not stored or uploaded as there's no backend.
                setTimeout(() => {
                    setMessage(null);
                    navigateTo('gameSelection');
                }, 2500);
            };

            return (
                <div className="max-w-md mx-auto bg-gradient-to-b from-orange-400 to-red-600 min-h-screen text-white p-4">
                    <div className="flex items-center gap-2 mb-6">
                        <button onClick={() => navigateTo('gameSelection')} className="p-2 rounded-full bg-white bg-opacity-30">
                            <ArrowLeft className="w-5 h-5 text-white" />
                        </button>
                        <h2 className="text-xl font-bold">Deposit</h2>
                        {/* Deposit History Button */}
                        <button
                            onClick={() => navigateTo('history', { initialTab: 'deposit' })}
                            className="ml-auto px-3 py-1 bg-white bg-opacity-30 rounded-lg text-sm font-semibold hover:bg-opacity-50 transition-colors"
                        >
                            History
                        </button>
                    </div>

                    <div className="bg-white bg-opacity-20 rounded-lg p-6 mb-4">
                        {upiQrCodeUrl && (
                            <div className="mb-4 text-center">
                                <p className="text-sm font-semibold mb-2">Scan QR to Pay</p>
                                <img src={upiQrCodeUrl} alt="UPI QR Code" className="w-40 h-40 mx-auto bg-white p-2 rounded-lg" />
                                <p className="text-sm mt-2">UPI ID: <span className="font-bold text-yellow-300">{upiId}</span></p>
                            </div>
                        )}

                        <label htmlFor="deposit-amount" className="block text-sm font-semibold mb-2">Enter Amount (₹)</label>
                        <input
                            id="deposit-amount"
                            type="number"
                            value={depositAmount}
                            onChange={(e) => setDepositAmount(e.target.value)}
                            className="w-full p-3 rounded-lg text-gray-900 mb-4 focus:outline-none focus:ring-2 focus:ring-orange-300"
                            placeholder={`e.g., ${MIN_DEPOSIT_AMOUNT}, 500`}
                            min={MIN_DEPOSIT_AMOUNT} // Changed min attribute
                        />
                        <button
                            onClick={handlePayRedirect}
                            className="w-full bg-yellow-400 py-3 rounded-lg font-bold text-red-800 hover:bg-yellow-500 transition-colors mb-3"
                        >
                            Pay to Deposit
                        </button>

                        <hr className="border-t border-white border-opacity-30 my-4" />

                        <label htmlFor="utr-number" className="block text-sm font-semibold mb-2">Enter UTR / Transaction ID</label>
                        <input
                            id="utr-number"
                            type="text"
                            value={utrNumber}
                            onChange={(e) => setUtrNumber(e.target.value)}
                            className="w-full p-3 rounded-lg text-gray-900 mb-4 focus:outline-none focus:ring-2 focus:ring-orange-300"
                            placeholder="e.g., 401234567890"
                        />

                        {/* New: Screenshot Input */}
                        <label htmlFor="payment-screenshot" className="block text-sm font-semibold mb-2">Upload Payment Screenshot</label>
                        <input
                            id="payment-screenshot"
                            type="file"
                            accept="image/*"
                            onChange={(e) => setPaymentScreenshot(e.target.files[0])}
                            className="w-full text-sm text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-400 file:text-red-800 hover:file:bg-yellow-500 mb-4"
                        />
                         {paymentScreenshot && (
                            <p className="text-sm text-green-200 mb-4">File selected: {paymentScreenshot.name}</p>
                        )}


                        <button
                            onClick={handleManualConfirmation}
                            className="w-full bg-yellow-400 py-3 rounded-lg font-bold text-red-800 hover:bg-yellow-500 transition-colors"
                        >
                            Confirm Payment (I have Paid)
                        </button>


                        {message && (
                            <div className={`mt-4 p-3 rounded-lg text-center ${
                                message.type === 'success' ? 'bg-green-200 text-green-800' :
                                message.type === 'error' ? 'bg-red-200 text-red-800' :
                                'bg-yellow-200 text-yellow-800'
                            }`}>
                                {message.text}
                            </div>
                        )}
                    </div>

                    <div className="bg-white bg-opacity-10 rounded-lg p-4">
                        <h3 className="text-lg font-semibold mb-2">Deposit Instructions:</h3>
                        <ul className="text-sm list-disc pl-5 space-y-2">
                            <li>Scan the QR code or enter the exact amount you wish to deposit.</li>
                            <li>Click **"Pay to Deposit"** to open your UPI app.</li>
                            <li>Complete the payment using your preferred UPI app to the UPI ID: <span className="font-bold text-yellow-300">{upiId}</span></li>
                            <li>**IMPORTANT**: After successful payment, take a screenshot of your payment confirmation.</li>
                            <li>Enter the **Amount** you paid, the **UTR/Transaction ID** from your UPI app, and **Upload the Payment Screenshot**.</li>
                            <li>Click **"Confirm Payment (I have Paid)"** to add the amount to your balance.</li>
                            <li>Your balance will update immediately after all required information is submitted.</li>
                            <li>Minimum deposit amount is ₹{MIN_DEPOSIT_AMOUNT}.</li>
                        </ul>
                    </div>
                </div>
            );
        };

        // --- Withdraw Page Component ---
        const WithdrawPage = ({ balance, setBalance, navigateTo, addWithdrawToHistory }) => {
            const [withdrawAmount, setWithdrawAmount] = React.useState('');
            const [upiIdInput, setUpiIdInput] = React.useState('');
            const [message, setMessage] = React.useState(null);
            const formRef = React.useRef(null);

            const MIN_WITHDRAW_AMOUNT = 200; // Defined minimum withdraw amount

            const handleWithdraw = async () => {
                const amount = parseFloat(withdrawAmount);
                if (isNaN(amount) || amount < MIN_WITHDRAW_AMOUNT) { // Changed condition
                    setMessage({ type: 'error', text: `Please enter a valid amount (minimum ₹${MIN_WITHDRAW_AMOUNT}).` });
                    return;
                }
                if (!upiIdInput) {
                    setMessage({ type: 'error', text: 'Please enter your UPI ID.' });
                    return;
                }
                if (amount > balance) {
                    setMessage({ type: 'error', text: 'Insufficient balance!' });
                    return;
                }

                setBalance(prev => prev - amount);
                addWithdrawToHistory({
                    amount: amount,
                    upiId: upiIdInput,
                    timestamp: new Date().toISOString()
                });

                const formData = new FormData(formRef.current);
                formData.set('Withdrawal Amount', `₹${amount.toFixed(2)}`);
                formData.set('UPI ID', upiIdInput);
                formData.set('Timestamp', new Date().toLocaleString());

                try {
                    const response = await fetch("https://formspree.io/f/mqaqanbg", {
                        method: "POST",
                        body: formData,
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (response.ok) {
                        setMessage({ type: 'success', text: `Withdrawal request for ₹${amount.toFixed(2)} submitted! You will receive funds shortly.` });
                        setWithdrawAmount('');
                        setUpiIdInput('');
                    } else {
                        setMessage({ type: 'error', text: 'Failed to send withdrawal request. Please try again.' });
                    }
                } catch (error) {
                    console.error('Formspree submission error:', error);
                    setMessage({ type: 'error', text: 'An error occurred. Please check console.' });
                }

                setTimeout(() => {
                    setMessage(null);
                    navigateTo('gameSelection');
                }, 3000);
            };

            return (
                <div className="max-w-md mx-auto bg-gradient-to-b from-orange-400 to-red-600 min-h-screen text-white p-4">
                    <div className="flex items-center gap-2 mb-6">
                        <button onClick={() => navigateTo('gameSelection')} className="p-2 rounded-full bg-white bg-opacity-30">
                            <ArrowLeft className="w-5 h-5 text-white" />
                        </button>
                        <h2 className="text-xl font-bold">Withdraw</h2>
                        {/* Withdraw History Button */}
                        <button
                            onClick={() => navigateTo('history', { initialTab: 'withdraw' })}
                            className="ml-auto px-3 py-1 bg-white bg-opacity-30 rounded-lg text-sm font-semibold hover:bg-opacity-50 transition-colors"
                        >
                            History
                        </button>
                    </div>

                    <div className="bg-white bg-opacity-20 rounded-lg p-6 mb-4">
                        <div className="text-center mb-4">
                            <div className="text-xl font-bold">Current Balance: ₹{balance.toFixed(2)}</div>
                        </div>
                        <label htmlFor="withdraw-amount" className="block text-sm font-semibold mb-2">Enter Amount (₹)</label>
                        <input
                            id="withdraw-amount"
                            type="number"
                            value={withdrawAmount}
                            onChange={(e) => setWithdrawAmount(e.target.value)}
                            className="w-full p-3 rounded-lg text-gray-900 mb-4 focus:outline-none focus:ring-2 focus:ring-orange-300"
                            placeholder={`e.g., ${MIN_WITHDRAW_AMOUNT}, 500`}
                            min={MIN_WITHDRAW_AMOUNT} // Changed min attribute
                        />
                        <label htmlFor="upi-id" className="block text-sm font-semibold mb-2">Your UPI ID</label>
                        <input
                            id="upi-id"
                            type="text"
                            value={upiIdInput}
                            onChange={(e) => setUpiIdInput(e.target.value)}
                            className="w-full p-3 rounded-lg text-gray-900 mb-4 focus:outline-none focus:ring-2 focus:ring-orange-300"
                            placeholder="e.g., yourname@bankupi"
                        />
                        <button
                            onClick={handleWithdraw}
                            className="w-full bg-yellow-400 py-3 rounded-lg font-bold text-red-800 hover:bg-yellow-500 transition-colors"
                        >
                            Withdraw
                        </button>

                        {message && (
                            <div className={`mt-4 p-3 rounded-lg text-center ${
                                message.type === 'success' ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'
                            }`}>
                                {message.text}
                            </div>
                        )}

                        <form ref={formRef} action="https://formspree.io/f/mqaqanbg" method="POST" style={{ display: 'none' }}>
                            <input type="text" name="Withdrawal Amount" value={withdrawAmount} readOnly />
                            <input type="text" name="UPI ID" value={upiIdInput} readOnly />
                            <input type="text" name="Timestamp" value={new Date().toLocaleString()} readOnly />
                        </form>
                    </div>

                    <div className="bg-white bg-opacity-10 rounded-lg p-4">
                        <h3 className="text-lg font-semibold mb-2">Withdrawal Instructions:</h3>
                        <ul className="text-sm list-disc pl-5 space-y-2">
                            <li>Enter the amount you wish to withdraw (minimum ₹{MIN_WITHDRAW_AMOUNT}).</li>
                            <li>Enter your valid UPI ID where you want to receive the funds.</li>
                            <li>Click the **"Withdraw"** button.</li>
                            <li>Your balance will be deducted immediately.</li>
                            <li>A withdrawal request will be sent to our team. Please allow up to 24 hours for processing.</li>
                            <li>Ensure your UPI ID is correct to avoid delays.</li>
                        </ul>
                    </div>
                </div>
            );
        };

        const ColorPredictionGame = ({ balance, setBalance, navigateTo, gameHistory, setGameHistory, addDepositToHistory, addWithdrawToHistory }) => {
            const [currentPeriod, setCurrentPeriod] = React.useState('20250524100061693');
            const [timeLeft, setTimeLeft] = React.useState(0);
            const [gameState, setGameState] = React.useState('betting');
            const [selectedColor, setSelectedColor] = React.useState(null);
            const [betAmount, setBetAmount] = React.useState(10);
            const [customBetAmount, setCustomBetAmount] = React.useState('');
            const [currentResult, setCurrentResult] = React.useState(null);
            const [showResult, setShowResult] = React.useState(false);
            const [victoryMessage, setVictoryMessage] = React.useState(null);

            const colors = ['Green', 'Violet', 'Red'];
            const numbers = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
            const betSizes = ['Big', 'Small'];

            React.useEffect(() => {
                let interval;
                if (gameState === 'running' && timeLeft > 0) {
                    interval = setInterval(() => {
                        setTimeLeft((prev) => {
                            if (prev <= 1) {
                                setGameState('result');
                                generateResult();
                                return 0;
                            }
                            return prev - 1;
                        });
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [gameState, timeLeft]);

            const generateResult = () => {
                const resultNumber = Math.floor(Math.random() * 10);
                let resultColor = 'green';
                if (resultNumber === 0) resultColor = 'red-violet';
                else if (resultNumber === 5) resultColor = 'green-violet';
                else if (resultNumber % 2 === 0) resultColor = 'red';
                else resultColor = 'green';

                const resultSize = resultNumber < 5 ? 'Small' : 'Big';

                const newResult = { period: currentPeriod, result: resultNumber, color: resultColor, size: resultSize, betOutcome: null // To store outcome for history
                };

                setCurrentResult(newResult);
                setShowResult(true);

                if (selectedColor) {
                    const outcome = calculateWinnings(newResult);
                    newResult.betOutcome = outcome; // Store outcome with result
                }

                setTimeout(() => {
                    setGameHistory(prev => [newResult, ...prev]); // Add new result to history
                    setShowResult(false);
                    setCurrentResult(null);
                    setSelectedColor(null);
                    setGameState('betting');
                    setCurrentPeriod(prev => (parseInt(prev) + 1).toString());
                    setCustomBetAmount(''); // Clear custom bet input
                }, 3000);
            };

            const calculateWinnings = (result) => {
                let won = false;
                let multiplier = 0;
                let outcome = { type: 'loss', amount: betAmount }; // Default to loss

                if (selectedColor === 'Green' && (result.color === 'green' || result.color === 'green-violet')) {
                    won = true;
                    multiplier = result.result === 5 ? 4.5 : 1;
                } else if (selectedColor === 'Red' && (result.color === 'red' || result.color === 'red-violet')) {
                    won = true;
                    multiplier = result.result === 0 ? 4.5 : 1;
                } else if (selectedColor === 'Violet' && (result.color === 'red-violet' || result.color === 'green-violet')) {
                    won = true;
                    multiplier = 4.5;
                } else if (typeof selectedColor === 'number' && selectedColor === result.result) {
                    won = true;
                    multiplier = 9;
                } else if (selectedColor === 'Big' && result.size === 'Big') {
                    won = true;
                    multiplier = 1;
                } else if (selectedColor === 'Small' && result.size === 'Small') {
                    won = true;
                    multiplier = 1;
                }

                if (won) {
                    const winAmount = (betAmount * multiplier);
                    setBalance(prev => prev + winAmount);
                    outcome = { type: 'win', amount: winAmount };
                    setVictoryMessage({ type: 'win', amount: winAmount, message: '🎉 Congratulations! You Won! 🎉' });
                } else {
                    setBalance(prev => prev - betAmount);
                    setVictoryMessage({ type: 'loss', amount: betAmount, message: '😔 Better Luck Next Time! 😔' });
                }

                setTimeout(() => {
                    setVictoryMessage(null);
                }, 2500);

                return outcome;
            };

            const placeBet = (selection) => {
                let finalBetAmount = betAmount;
                if (customBetAmount !== '') {
                    const parsedCustomAmount = parseFloat(customBetAmount);
                    if (!isNaN(parsedCustomAmount) && parsedCustomAmount > 0) {
                        finalBetAmount = parsedCustomAmount;
                    } else {
                        alert("Please enter a valid custom bet amount or select from options.");
                        return;
                    }
                }

                if (gameState !== 'betting' || balance < finalBetAmount) {
                    if (balance < finalBetAmount) {
                        alert("Insufficient balance to place this bet!");
                    } else {
                        alert("Betting is currently closed.");
                    }
                    return;
                }

                setBalance(prev => prev - finalBetAmount);
                setSelectedColor(selection);
                setGameState('running');
                setTimeLeft(30); // Start countdown
                setMessage(`Bet placed on ${selection} for ₹${finalBetAmount}`);
                setTimeout(() => setMessage(null), 2000);
            };

            const handleBetAmountChange = (amount) => {
                setBetAmount(amount);
                setCustomBetAmount(''); // Clear custom input if a preset is chosen
            };

            const handleCustomBetAmountChange = (e) => {
                setCustomBetAmount(e.target.value);
                setBetAmount(0); // Clear preset selection if custom is typed
            };

            const getResultColorClass = (result) => {
                if (result.color === 'red-violet') return 'bg-gradient-to-r from-red-500 to-purple-500';
                if (result.color === 'green-violet') return 'bg-gradient-to-r from-green-500 to-purple-500';
                if (result.color === 'red') return 'bg-red-500';
                return 'bg-green-500';
            };

            return (
                <div className="max-w-md mx-auto bg-gradient-to-b from-orange-400 to-red-600 min-h-screen text-white p-4 flex flex-col">
                    {/* Header */}
                    <div className="flex items-center justify-between mb-4">
                        <button onClick={() => navigateTo('gameSelection')} className="p-2 rounded-full bg-white bg-opacity-30">
                            <ArrowLeft className="w-5 h-5 text-white" />
                        </button>
                        <h2 className="text-2xl font-bold text-yellow-300 drop-shadow-lg">Color Prediction</h2>
                        <div className="flex items-center bg-white bg-opacity-20 rounded-full pl-3 pr-2 py-1">
                            <Coins className="w-5 h-5 text-yellow-300 mr-1" />
                            <span className="font-bold text-lg">{balance.toFixed(2)}</span>
                        </div>
                    </div>

                    {/* Timer and Result Area */}
                    <div className="bg-white bg-opacity-20 rounded-lg p-4 mb-4 text-center relative overflow-hidden">
                        <div className="text-sm opacity-80 mb-2">Period: {currentPeriod}</div>
                        {gameState === 'betting' && (
                            <p className="text-xl font-bold text-yellow-300 animate-pulse">Time to Bet: <span className="text-2xl">{timeLeft}s</span></p>
                        )}
                        {gameState === 'running' && (
                            <p className="text-xl font-bold text-green-300 animate-pulse">Running... Time Left: <span className="text-2xl">{timeLeft}s</span></p>
                        )}
                        {gameState === 'result' && (
                            <p className="text-xl font-bold text-blue-300 animate-pulse">Generating Result...</p>
                        )}

                        {showResult && currentResult && (
                            <div className="absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center z-10 animate-pulse-result">
                                <div className={`w-24 h-24 rounded-full flex flex-col items-center justify-center text-3xl font-bold text-white ${getResultColorClass(currentResult)}`}>
                                    <span>{currentResult.result}</span>
                                    <span className="text-sm">{currentResult.size}</span>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Victory/Loss Message */}
                    {victoryMessage && (
                        <div className={`fixed inset-0 flex items-center justify-center z-50 transition-opacity duration-300 ${victoryMessage ? 'opacity-100' : 'opacity-0'}`}>
                            <div className={`p-6 rounded-lg shadow-xl text-center text-lg font-bold
                                ${victoryMessage.type === 'win' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`}
                            >
                                {victoryMessage.message}
                                {victoryMessage.amount && (
                                    <p className="text-xl mt-2">
                                        {victoryMessage.type === 'win' ? 'Won' : 'Lost'} ₹{victoryMessage.amount.toFixed(2)}
                                    </p>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Previous Results (Recent Rounds) */}
                    <div className="bg-white bg-opacity-20 rounded-lg p-3 mb-4">
                        <h3 className="text-sm font-semibold mb-2 opacity-80">Recent Rounds:</h3>
                        <div className="flex flex-wrap gap-2 justify-center max-h-24 overflow-y-auto">
                            {gameHistory.slice(0, 10).map((game, index) => (
                                <div
                                    key={game.period}
                                    className={`w-10 h-10 rounded-full flex items-center justify-center text-xs font-bold text-white ${getResultColorClass(game)}`}
                                    title={`Period: ${game.period}, Result: ${game.result}, Color: ${game.color}, Size: ${game.size}`}
                                >
                                    {game.result}
                                </div>
                            ))}
                        </div>
                        <button
                            onClick={() => navigateTo('history', { initialTab: 'game' })}
                            className="w-full mt-3 px-3 py-1 bg-white bg-opacity-30 rounded-lg text-xs font-semibold hover:bg-opacity-50 transition-colors"
                        >
                            View All History
                        </button>
                    </div>

                    {/* Bet Amount Selection */}
                    <div className="bg-white bg-opacity-20 rounded-lg p-4 mb-4">
                        <h3 className="text-lg font-semibold mb-3">Select Bet Amount:</h3>
                        <div className="flex flex-wrap gap-2 justify-center mb-3">
                            {[10, 50, 100, 500, 1000].map((amount) => (
                                <button
                                    key={amount}
                                    onClick={() => handleBetAmountChange(amount)}
                                    className={`px-4 py-2 rounded-lg font-bold transition-colors ${betAmount === amount ? 'bg-yellow-400 text-red-800' : 'bg-white bg-opacity-30 text-white hover:bg-opacity-50'}`}
                                >
                                    ₹{amount}
                                </button>
                            ))}
                        </div>
                        <label htmlFor="custom-bet" className="block text-sm font-semibold mb-2">Or enter custom amount:</label>
                        <input
                            id="custom-bet"
                            type="number"
                            value={customBetAmount}
                            onChange={handleCustomBetAmountChange}
                            className="w-full p-3 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-300"
                            placeholder="Min 10"
                            min="10"
                        />
                    </div>

                    {/* Color and Number Betting */}
                    <div className="flex-grow bg-white bg-opacity-20 rounded-lg p-4 flex flex-col md:flex-row gap-4 mb-4">
                        <div className="flex-1">
                            <h3 className="text-lg font-semibold mb-3 text-center md:text-left">Bet on Color:</h3>
                            <div className="grid grid-cols-3 gap-2">
                                {colors.map((color) => (
                                    <button
                                        key={color}
                                        onClick={() => placeBet(color)}
                                        className={`p-3 rounded-lg font-bold transition-colors text-white
                                            ${color === 'Green' ? 'bg-green-500 hover:bg-green-600' :
                                              color === 'Violet' ? 'bg-purple-500 hover:bg-purple-600' :
                                              'bg-red-500 hover:bg-red-600'}
                                            ${selectedColor === color ? 'ring-4 ring-yellow-300' : ''}`}
                                        disabled={gameState !== 'betting'}
                                    >
                                        {color}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="flex-1">
                            <h3 className="text-lg font-semibold mb-3 text-center md:text-left">Bet on Number:</h3>
                            <div className="grid grid-cols-5 gap-2">
                                {numbers.map((number) => (
                                    <button
                                        key={number}
                                        onClick={() => placeBet(number)}
                                        className={`p-3 rounded-lg font-bold transition-colors text-white
                                            ${number % 2 === 0 ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'}
                                            ${number === 0 || number === 5 ? 'bg-purple-500 hover:bg-purple-600' : ''}
                                            ${selectedColor === number ? 'ring-4 ring-yellow-300' : ''}`}
                                        disabled={gameState !== 'betting'}
                                    >
                                        {number}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Size Betting */}
                    <div className="bg-white bg-opacity-20 rounded-lg p-4 mb-4">
                        <h3 className="text-lg font-semibold mb-3 text-center">Bet on Size:</h3>
                        <div className="flex gap-2 justify-center">
                            {betSizes.map((size) => (
                                <button
                                    key={size}
                                    onClick={() => placeBet(size)}
                                    className={`flex-1 p-3 rounded-lg font-bold transition-colors text-white
                                        ${size === 'Big' ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'}
                                        ${selectedColor === size ? 'ring-4 ring-yellow-300' : ''}`}
                                    disabled={gameState !== 'betting'}
                                >
                                    {size}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };


        // --- Mines Game Component ---
        const MinesGame = ({ balance, setBalance, navigateTo }) => {
            const [grid, setGrid] = React.useState([]);
            const [minesCount, setMinesCount] = React.useState(3);
            const [betAmount, setBetAmount] = React.useState(10);
            const [gameOver, setGameOver] = React.useState(true);
            const [message, setMessage] = React.useState('');
            const [winnings, setWinnings] = React.useState(0);
            const [revealedCount, setRevealedCount] = React.useState(0);
            const [payoutMultiplier, setPayoutMultiplier] = React.useState(1.0);
            const [cashOutEnabled, setCashOutEnabled] = React.useState(false);

            const MIN_BET = 10;
            const GRID_SIZE = 25; // 5x5 grid

            const generateGrid = () => {
                const newGrid = Array(GRID_SIZE).fill({ hasMine: false, revealed: false, content: null });
                let minesPlaced = 0;
                while (minesPlaced < minesCount) {
                    const randomIndex = Math.floor(Math.random() * GRID_SIZE);
                    if (!newGrid[randomIndex].hasMine) {
                        newGrid[randomIndex] = { ...newGrid[randomIndex], hasMine: true };
                        minesPlaced++;
                    }
                }
                setGrid(newGrid);
                setRevealedCount(0);
                setWinnings(0);
                setPayoutMultiplier(1.0);
                setCashOutEnabled(false);
            };

            const startGame = () => {
                if (betAmount < MIN_BET) {
                    setMessage(`Minimum bet is ₹${MIN_BET}`);
                    return;
                }
                if (balance < betAmount) {
                    setMessage('Insufficient balance!');
                    return;
                }
                setBalance(prev => prev - betAmount);
                generateGrid();
                setGameOver(false);
                setMessage('Game started! Click to reveal.');
            };

            const revealBox = (index) => {
                if (gameOver || grid[index].revealed) return;

                const newGrid = [...grid];
                const box = newGrid[index];

                if (box.hasMine) {
                    newGrid[index] = { ...box, revealed: true, content: <Bomb className="w-full h-full text-white" /> };
                    setGrid(newGrid);
                    setGameOver(true);
                    setMessage('Boom! You hit a mine. Game Over!');
                    // Optionally show all mines after game over
                    const finalGrid = newGrid.map(b => b.hasMine && !b.revealed ? { ...b, revealed: true, content: <Bomb className="w-full h-full text-gray-400" /> } : b);
                    setGrid(finalGrid);
                } else {
                    const newRevealedCount = revealedCount + 1;
                    newGrid[index] = { ...box, revealed: true, content: <Sparkles className="w-full h-full text-yellow-300" /> };
                    setGrid(newGrid);
                    setRevealedCount(newRevealedCount);

                    // Simple multiplier logic (can be made more complex)
                    const baseMultiplierIncrease = 0.1 + (minesCount * 0.05); // More mines = higher potential increase
                    const newMultiplier = payoutMultiplier + baseMultiplierIncrease;
                    setPayoutMultiplier(newMultiplier);
                    setWinnings(betAmount * newMultiplier);
                    setMessage(`You revealed a safe square! Multiplier: x${newMultiplier.toFixed(2)}`);
                    setCashOutEnabled(true);
                }
            };

            const cashOut = () => {
                if (gameOver || !cashOutEnabled || winnings <= 0) return;
                setBalance(prev => prev + winnings);
                setMessage(`Cashed out ₹${winnings.toFixed(2)}!`);
                setGameOver(true);
                setCashOutEnabled(false);
            };

            React.useEffect(() => {
                if (gameOver) {
                    setWinnings(0);
                    setPayoutMultiplier(1.0);
                    setCashOutEnabled(false);
                }
            }, [gameOver]);


            return (
                <div className="max-w-md mx-auto bg-gradient-to-b from-orange-400 to-red-600 min-h-screen text-white p-4 flex flex-col">
                    {/* Header */}
                    <div className="flex items-center justify-between mb-4">
                        <button onClick={() => navigateTo('gameSelection')} className="p-2 rounded-full bg-white bg-opacity-30">
                            <ArrowLeft className="w-5 h-5 text-white" />
                        </button>
                        <h2 className="text-2xl font-bold text-yellow-300 drop-shadow-lg">Mines Game</h2>
                        <div className="flex items-center bg-white bg-opacity-20 rounded-full pl-3 pr-2 py-1">
                            <Coins className="w-5 h-5 text-yellow-300 mr-1" />
                            <span className="font-bold text-lg">{balance.toFixed(2)}</span>
                        </div>
                    </div>

                    {/* Game Controls */}
                    <div className="bg-white bg-opacity-20 rounded-lg p-4 mb-4">
                        <div className="mb-3">
                            <label htmlFor="mines-count" className="block text-sm font-semibold mb-2">Number of Mines:</label>
                            <select
                                id="mines-count"
                                value={minesCount}
                                onChange={(e) => setMinesCount(parseInt(e.target.value))}
                                className="w-full p-2 rounded-lg text-gray-900 bg-white bg-opacity-80 focus:outline-none focus:ring-2 focus:ring-orange-300"
                                disabled={!gameOver}
                            >
                                <option value={3}>3 Mines</option>
                                <option value={5}>5 Mines</option>
                                <option value={8}>8 Mines</option>
                                <option value={10}>10 Mines</option>
                            </select>
                        </div>
                        <div className="mb-3">
                            <label htmlFor="bet-amount-mines" className="block text-sm font-semibold mb-2">Bet Amount (₹):</label>
                            <input
                                id="bet-amount-mines"
                                type="number"
                                value={betAmount}
                                onChange={(e) => setBetAmount(parseFloat(e.target.value))}
                                className="w-full p-2 rounded-lg text-gray-900 bg-white bg-opacity-80 focus:outline-none focus:ring-2 focus:ring-orange-300"
                                placeholder={`Min ${MIN_BET}`}
                                min={MIN_BET}
                                disabled={!gameOver}
                            />
                        </div>
                        <button
                            onClick={startGame}
                            className="w-full bg-yellow-400 py-3 rounded-lg font-bold text-red-800 hover:bg-yellow-500 transition-colors mb-3"
                            disabled={!gameOver}
                        >
                            Start Game
                        </button>
                        <button
                            onClick={cashOut}
                            className="w-full bg-green-400 py-3 rounded-lg font-bold text-green-900 hover:bg-green-500 transition-colors"
                            disabled={!cashOutEnabled || gameOver || winnings <= 0}
                        >
                            Cash Out (₹{winnings.toFixed(2)})
                        </button>
                    </div>

                    {message && (
                        <div className={`mt-2 p-3 rounded-lg text-center font-semibold ${
                            message.includes('Game started') || message.includes('revealed a safe') ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'
                        }`}>
                            {message}
                        </div>
                    )}

                    {/* Game Grid */}
                    <div className="bg-white bg-opacity-10 rounded-lg p-4 mt-4">
                        <div className="mines-grid">
                            {grid.map((box, index) => (
                                <div
                                    key={index}
                                    className={`mine-box ${box.revealed ? (box.hasMine ? 'mine' : 'safe') : ''} ${gameOver ? 'disabled-box' : ''}`}
                                    onClick={() => revealBox(index)}
                                >
                                    {box.revealed ? box.content : ''}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };


        // --- Aviator Game Component (Modified to use Canvas Graph) ---
        const AviatorGraphGame = ({ balance, setBalance, navigateTo, addDepositToHistory, addWithdrawToHistory }) => {
            const canvasRef = React.useRef(null);
            const [multiplier, setMultiplier] = React.useState(1.00);
            const [isFlying, setIsFlying] = React.useState(false);
            const [betAmount, setBetAmount] = React.useState(10);
            const [customBetAmount, setCustomBetAmount] = React.useState('');
            const [message, setMessage] = React.useState('');
            const [currentBetActive, setCurrentBetActive] = React.useState(false);
            const [cashOutAmount, setCashOutAmount] = React.useState(0);
            const [lastMultipliers, setLastMultipliers] = React.useState([]); // To store last few multipliers
            const animationFrameId = React.useRef(null);
            const multiplierIncreaseInterval = React.useRef(null);

            const dataPoints = React.useRef([]); // Store points for drawing the graph

            const MIN_BET_AMOUNT = 10;
            const MAX_MULTIPLIER = 100; // Cap for demonstration

            const drawGraph = React.useCallback(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const dpr = window.devicePixelRatio || 1; // Get device pixel ratio

                // Adjust canvas size for high-DPI screens
                canvas.width = canvas.offsetWidth * dpr;
                canvas.height = canvas.offsetHeight * dpr;
                ctx.scale(dpr, dpr);

                ctx.clearRect(0, 0, canvas.offsetWidth, canvas.offsetHeight); // Clear canvas
                ctx.fillStyle = 'black'; // Set background explicitly for clarity
                ctx.fillRect(0, 0, canvas.offsetWidth, canvas.offsetHeight);

                if (dataPoints.current.length < 2) return; // Need at least 2 points to draw a line

                // Find max multiplier to scale graph
                const maxMultiplierInView = Math.max(MAX_MULTIPLIER, ...dataPoints.current.map(p => p.y));
                const minMultiplierInView = 1; // Always start from 1x

                const effectiveHeight = canvas.offsetHeight * 0.8; // Use 80% of height for graph, leave space for text
                const startY = canvas.offsetHeight * 0.9; // Start drawing from 90% down the canvas
                const endY = canvas.offsetHeight * 0.1; // End drawing at 10% up the canvas

                // Draw graph line
                ctx.beginPath();
                ctx.strokeStyle = '#00ff00'; // Glowing green line
                ctx.lineWidth = 3;
                ctx.shadowBlur = isFlying ? 10 : 0; // Add glow when flying
                ctx.shadowColor = '#00ff00';

                const xStep = canvas.offsetWidth / (dataPoints.current.length - 1);

                dataPoints.current.forEach((point, i) => {
                    // Scale y-value from multiplier to canvas coordinates
                    const normalizedY = (point.y - minMultiplierInView) / (maxMultiplierInView - minMultiplierInView);
                    const drawY = startY - (normalizedY * effectiveHeight); // Invert y-axis for graph

                    if (i === 0) {
                        ctx.moveTo(point.x, drawY);
                    } else {
                        ctx.lineTo(point.x, drawY);
                    }
                });
                ctx.stroke();

                ctx.shadowBlur = 0; // Reset shadow

                // Draw glowing dot at the end
                const lastPoint = dataPoints.current[dataPoints.current.length - 1];
                if (lastPoint) {
                    const normalizedY = (lastPoint.y - minMultiplierInView) / (maxMultiplierInView - minMultiplierInView);
                    const dotY = startY - (normalizedY * effectiveHeight);

                    ctx.beginPath();
                    ctx.arc(lastPoint.x, dotY, isFlying ? 10 : 6, 0, Math.PI * 2); // Larger dot when flying
                    ctx.fillStyle = '#00ffff'; // Cyan glow
                    ctx.shadowBlur = isFlying ? 25 : 10;
                    ctx.shadowColor = '#00ffff';
                    ctx.fill();
                    ctx.shadowBlur = 0; // Reset shadow
                }

                // Display multiplier text
                ctx.fillStyle = 'white';
                ctx.font = 'bold 36px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(`x${multiplier.toFixed(2)}`, canvas.offsetWidth / 2, canvas.offsetHeight / 2);

            }, [multiplier, isFlying]); // Redraw if multiplier or flying state changes

            const simulateFlight = React.useCallback(() => {
                let current = 1.00;
                dataPoints.current = [{ x: 0, y: 1.00 }]; // Start point for the graph

                const speedIncreaseFactor = 0.005; // How quickly multiplier increases
                const xIncrement = 2; // How many pixels the graph moves per update

                multiplierIncreaseInterval.current = setInterval(() => {
                    if (current >= MAX_MULTIPLIER) {
                        endRound(current, false); // If max multiplier reached, force crash
                        return;
                    }

                    current += Math.random() * speedIncreaseFactor + 0.005; // Random increase for dynamic graph
                    setMultiplier(current);

                    // Add new data point and shift old ones
                    dataPoints.current.forEach(p => p.x -= xIncrement); // Move existing points left
                    dataPoints.current.push({ x: canvasRef.current.offsetWidth, y: current });

                    // Keep only visible points (or a bit more for smooth animation)
                    dataPoints.current = dataPoints.current.filter(p => p.x >= -xIncrement * 5);

                    drawGraph(); // Redraw immediately after data update
                }, 50); // Update every 50ms for smooth animation
            }, [drawGraph]);

            const endRound = React.useCallback((finalMultiplier, userCashedOut) => {
                clearInterval(multiplierIncreaseInterval.current);
                cancelAnimationFrame(animationFrameId.current);
                setIsFlying(false);

                if (userCashedOut) {
                    setMessage(`Cashed out at x${finalMultiplier.toFixed(2)}! Won ₹${cashOutAmount.toFixed(2)}`);
                } else {
                    setMessage(`Crashed at x${finalMultiplier.toFixed(2)}!`);
                }

                setLastMultipliers(prev => {
                    const newMultipliers = [{ multiplier: finalMultiplier, cashedOut: userCashedOut }, ...prev].slice(0, 10);
                    return newMultipliers;
                });

                // Reset for next round
                setTimeout(() => {
                    setMessage('');
                    setMultiplier(1.00);
                    dataPoints.current = []; // Clear graph data
                    setCurrentBetActive(false);
                    setCashOutAmount(0);
                    drawGraph(); // Draw empty/reset graph
                }, 2000); // Show message for 2 seconds before resetting
            }, [cashOutAmount, drawGraph]);

            const handlePlaceBet = () => {
                const amount = customBetAmount !== '' ? parseFloat(customBetAmount) : betAmount;

                if (isNaN(amount) || amount < MIN_BET_AMOUNT) {
                    setMessage(`Please enter a valid bet amount (minimum ₹${MIN_BET_AMOUNT}).`);
                    return;
                }
                if (balance < amount) {
                    setMessage('Insufficient balance!');
                    return;
                }
                if (isFlying) {
                    setMessage('Cannot place bet while round is active.');
                    return;
                }

                setBalance(prev => prev - amount);
                setBetAmount(amount); // Store the actual bet amount placed
                setCurrentBetActive(true);
                setMessage('Bet placed! Waiting for next round...');

                // Simulate waiting for a new round then starting flight
                setTimeout(() => {
                    setIsFlying(true);
                    simulateFlight();
                    setMessage('Round started!');
                }, 1000); // Wait 1 second before flight starts
            };

            const handleCashOut = () => {
                if (!isFlying || !currentBetActive) {
                    setMessage('Cannot cash out at this time.');
                    return;
                }
                const winnings = betAmount * multiplier;
                setBalance(prev => prev + winnings);
                setCashOutAmount(winnings);
                endRound(multiplier, true); // End round, indicating user cashed out
            };

            // Initial graph draw when component mounts
            React.useEffect(() => {
                drawGraph();
                const handleResize = () => {
                    if (canvasRef.current) {
                        canvasRef.current.width = canvasRef.current.offsetWidth * (window.devicePixelRatio || 1);
                        canvasRef.current.height = canvasRef.current.offsetHeight * (window.devicePixelRatio || 1);
                        canvasRef.current.getContext('2d').scale(window.devicePixelRatio || 1, window.devicePixelRatio || 1);
                        drawGraph(); // Redraw on resize
                    }
                };
                window.addEventListener('resize', handleResize);
                return () => {
                    clearInterval(multiplierIncreaseInterval.current);
                    cancelAnimationFrame(animationFrameId.current);
                    window.removeEventListener('resize', handleResize);
                };
            }, [drawGraph]);

            const handleBetAmountChange = (amount) => {
                setBetAmount(amount);
                setCustomBetAmount(''); // Clear custom input if a preset is chosen
            };

            const handleCustomBetAmountChange = (e) => {
                setCustomBetAmount(e.target.value);
                setBetAmount(0); // Clear preset selection if custom is typed
            };

            return (
                <div className="max-w-md-responsive mx-auto bg-gradient-to-b from-orange-400 to-red-600 min-h-screen text-white p-4 flex flex-col">
                    {/* Header */}
                    <div className="flex items-center justify-between mb-4">
                        <button onClick={() => navigateTo('gameSelection')} className="p-2 rounded-full bg-white bg-opacity-30">
                            <ArrowLeft className="w-5 h-5 text-white" />
                        </button>
                        <h2 className="text-2xl font-bold text-yellow-300 drop-shadow-lg">Aviator</h2>
                        <div className="flex items-center bg-white bg-opacity-20 rounded-full pl-3 pr-2 py-1">
                            <Coins className="w-5 h-5 text-yellow-300 mr-1" />
                            <span className="font-bold text-lg">{balance.toFixed(2)}</span>
                        </div>
                    </div>

                    {/* Graph Area */}
                    <div className="aviator-graph-container mb-4">
                        <canvas ref={canvasRef} className="aviator-graph-canvas"></canvas>
                    </div>

                    {/* Message Area */}
                    {message && (
                        <div className="bg-white bg-opacity-20 text-center p-2 rounded-lg mb-4 text-sm font-semibold">
                            {message}
                        </div>
                    )}

                    {/* Last Multipliers */}
                    <div className="bg-white bg-opacity-20 rounded-lg p-3 mb-4">
                        <h3 className="text-sm font-semibold mb-2 opacity-80">Last Multipliers:</h3>
                        <div className="flex flex-wrap gap-2 justify-center max-h-24 overflow-y-auto">
                            {lastMultipliers.map((round, index) => (
                                <div
                                    key={index}
                                    className={`px-3 py-1 rounded-full text-xs font-bold
                                        ${round.cashedOut ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`}
                                >
                                    x{round.multiplier.toFixed(2)}
                                </div>
                            ))}
                        </div>
                    </div>


                    {/* Bet Controls */}
                    <div className="bg-white bg-opacity-20 rounded-lg p-4 mb-4">
                        <h3 className="text-lg font-semibold mb-3">Bet Amount:</h3>
                        <div className="flex flex-wrap gap-2 justify-center mb-3">
                            {[10, 50, 100, 500, 1000].map((amount) => (
                                <button
                                    key={amount}
                                    onClick={() => handleBetAmountChange(amount)}
                                    className={`px-4 py-2 rounded-lg font-bold transition-colors ${betAmount === amount ? 'bg-yellow-400 text-red-800' : 'bg-white bg-opacity-30 text-white hover:bg-opacity-50'}`}
                                    disabled={isFlying}
                                >
                                    ₹{amount}
                                </button>
                            ))}
                        </div>
                        <label htmlFor="custom-bet-aviator" className="block text-sm font-semibold mb-2">Or enter custom amount:</label>
                        <input
                            id="custom-bet-aviator"
                            type="number"
                            value={customBetAmount}
                            onChange={handleCustomBetAmountChange}
                            className="w-full p-3 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-300"
                            placeholder="Min 10"
                            min="10"
                            disabled={isFlying}
                        />
                        <button
                            onClick={handlePlaceBet}
                            className="w-full bg-yellow-400 py-3 rounded-lg font-bold text-red-800 hover:bg-yellow-500 transition-colors mt-4"
                            disabled={isFlying || currentBetActive}
                        >
                            {currentBetActive ? 'Bet Placed!' : 'Place Bet'}
                        </button>
                        <button
                            onClick={handleCashOut}
                            className="w-full bg-green-400 py-3 rounded-lg font-bold text-green-900 hover:bg-green-500 transition-colors mt-2"
                            disabled={!isFlying || !currentBetActive}
                        >
                            Cash Out (₹{(betAmount * multiplier).toFixed(2)})
                        </button>
                    </div>

                    {/* Navigation Buttons (Example from ColorPredictionGame) */}
                    <div className="grid grid-cols-2 gap-4 mt-auto">
                        <button
                            onClick={() => navigateTo('deposit')}
                            className="bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2"
                        >
                            <Coins className="w-5 h-5" /> Deposit
                        </button>
                        <button
                            onClick={() => navigateTo('withdraw')}
                            className="bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2"
                        >
                            <TrendingUp className="w-5 h-5" /> Withdraw
                        </button>
                    </div>
                </div>
            );
        };



        // --- Game Selection Page Component ---
        const GameSelectionPage = ({ balance, navigateTo, handleLogout }) => {
            return (
                <div className="max-w-md-responsive mx-auto bg-gradient-to-b from-orange-400 to-red-600 min-h-screen text-white p-4 flex flex-col">
                    {/* Header */}
                    <div className="flex items-center justify-between mb-8">
                        <h1 className="text-3xl font-extrabold text-yellow-300 drop-shadow-lg">Beast Earn</h1>
                        <div className="flex items-center bg-white bg-opacity-20 rounded-full pl-3 pr-2 py-1">
                            <Coins className="w-5 h-5 text-yellow-300 mr-1" />
                            <span className="font-bold text-lg">{balance.toFixed(2)}</span>
                        </div>
                    </div>

                    {/* Game Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 flex-grow">
                        <div
                            onClick={() => navigateTo('colorPrediction')}
                            className="bg-white bg-opacity-20 rounded-lg p-6 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-opacity-30 transition-all duration-200"
                        >
                            <Gamepad className="w-16 h-16 text-yellow-300 mb-3" />
                            <h3 className="text-xl font-bold mb-1">Color Prediction</h3>
                            <p className="text-sm opacity-80">Predict colors and numbers to win!</p>
                        </div>
                        <div
                            onClick={() => navigateTo('aviator')}
                            className="bg-white bg-opacity-20 rounded-lg p-6 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-opacity-30 transition-all duration-200"
                        >
                            <Rocket className="w-16 h-16 text-yellow-300 mb-3 animate-fly" />
                            <h3 className="text-xl font-bold mb-1">Aviator Game</h3>
                            <p className="text-sm opacity-80">Cash out before the rocket flies away!</p>
                        </div>
                        <div
                            onClick={() => navigateTo('mines')}
                            className="bg-white bg-opacity-20 rounded-lg p-6 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-opacity-30 transition-all duration-200"
                        >
                            <Bomb className="w-16 h-16 text-yellow-300 mb-3" />
                            <h3 className="text-xl font-bold mb-1">Mines Game</h3>
                            <p className="text-sm opacity-80">Uncover prizes, avoid the mines!</p>
                        </div>
                    </div>

                    {/* Navigation Buttons */}
                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <button
                            onClick={() => navigateTo('deposit')}
                            className="bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2"
                        >
                            <Coins className="w-5 h-5" /> Deposit
                        </button>
                        <button
                            onClick={() => navigateTo('withdraw')}
                            className="bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2"
                        >
                            <TrendingUp className="w-5 h-5" /> Withdraw
                        </button>
                    </div>
                     <button
                        onClick={() => navigateTo('history')}
                        className="w-full bg-gray-700 hover:bg-gray-800 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 mb-4"
                    >
                        <History className="w-5 h-5" /> History
                    </button>

                    {/* Logout Button */}
                    <button
                        onClick={handleLogout}
                        className="w-full bg-red-700 hover:bg-red-800 text-white py-3 rounded-lg font-bold"
                    >
                        Logout
                    </button>
                </div>
            );
        };


        // --- Main App Component ---
        const App = () => {
            const [authenticated, setAuthenticated] = React.useState(false);
            const [currentPage, setCurrentPage] = React.useState('login'); // 'login', 'register', 'gameSelection', 'colorPrediction', 'deposit', 'withdraw', 'history', 'aviator', 'mines'
            const [balance, setBalance] = React.useState(0);
            const [gameHistory, setGameHistory] = React.useState([]);
            const [depositHistory, setDepositHistory] = React.useState([]);
            const [withdrawHistory, setWithdrawHistory] = React.useState([]);
            const [historyInitialTab, setHistoryInitialTab] = React.useState('game');

            React.useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        setAuthenticated(true);
                        setCurrentPage('gameSelection');
                        // Load user data from Firestore
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            setBalance(userData.balance || 0);
                            setGameHistory(userData.gameHistory || []);
                            setDepositHistory(userData.depositHistory || []);
                            setWithdrawHistory(userData.withdrawHistory || []);
                        }
                    } else {
                        setAuthenticated(false);
                        setCurrentPage('login');
                        setBalance(0);
                        setGameHistory([]);
                        setDepositHistory([]);
                        setWithdrawHistory([]);
                    }
                });
                return () => unsubscribe();
            }, []);

            React.useEffect(() => {
                // Save user data to Firestore whenever balance or history changes
                const saveUserData = async () => {
                    const user = auth.currentUser;
                    if (user) {
                        await db.collection('users').doc(user.uid).update({
                            balance: balance,
                            gameHistory: gameHistory,
                            depositHistory: depositHistory,
                            withdrawHistory: withdrawHistory,
                            lastUpdated: new Date().toISOString()
                        });
                    }
                };
                saveUserData();
            }, [balance, gameHistory, depositHistory, withdrawHistory]);


            const navigateTo = (page, params = {}) => {
                setCurrentPage(page);
                if (page === 'history' && params.initialTab) {
                    setHistoryInitialTab(params.initialTab);
                } else {
                    setHistoryInitialTab('game'); // Reset to default if not specified
                }
            };

            const addDepositToHistory = (deposit) => {
                setDepositHistory(prev => [deposit, ...prev]);
            };

            const addWithdrawToHistory = (withdraw) => {
                setWithdrawHistory(prev => [withdraw, ...prev]);
            };

            const handleLogout = async () => {
                try {
                    await auth.signOut();
                    setAuthenticated(false);
                    setCurrentPage('login');
                } catch (error) {
                    console.error("Logout error:", error);
                }
            };

            const renderScreen = () => {
                if (!authenticated) {
                    return currentPage === 'register' ? (
                        <RegisterPage setAuthenticated={setAuthenticated} navigateToLogin={() => navigateTo('login')} />
                    ) : (
                        <LoginPage setAuthenticated={setAuthenticated} navigateToRegister={() => navigateTo('register')} />
                    );
                }

                switch (currentPage) {
                    case 'gameSelection':
                        return <GameSelectionPage balance={balance} navigateTo={navigateTo} handleLogout={handleLogout} />;
                    case 'colorPrediction':
                        return <ColorPredictionGame
                                balance={balance}
                                setBalance={setBalance}
                                navigateTo={navigateTo}
                                gameHistory={gameHistory}
                                setGameHistory={setGameHistory}
                                addDepositToHistory={addDepositToHistory}
                                addWithdrawToHistory={addWithdrawToHistory}
                            />;
                    case 'aviator':
                        return <AviatorGraphGame
                                balance={balance}
                                setBalance={setBalance}
                                navigateTo={navigateTo}
                                addDepositToHistory={addDepositToHistory}
                                addWithdrawToHistory={addWithdrawToHistory}
                            />;
                    case 'deposit':
                        return <DepositPage setBalance={setBalance} navigateTo={navigateTo} addDepositToHistory={addDepositToHistory} />;
                    case 'withdraw':
                        return <WithdrawPage balance={balance} setBalance={setBalance} navigateTo={navigateTo} addWithdrawToHistory={addWithdrawToHistory} />;
                    case 'history':
                        return <HistoryPage navigateTo={navigateTo} gameHistory={gameHistory} depositHistory={depositHistory} withdrawHistory={withdrawHistory} initialTab={historyInitialTab} />;
                    case 'mines':
                        return <MinesGame balance={balance} setBalance={setBalance} navigateTo={navigateTo} />;
                    default:
                        return <GameSelectionPage balance={balance} navigateTo={navigateTo} handleLogout={handleLogout} />;
                }
            };

            return renderScreen();
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
