<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOLT999 - Color Prediction</title>

    <meta name="theme-color" content="#111827">
    <meta name="description" content="BOLT999 - Play Color Prediction and Mine games to win real money!">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.avif">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="BOLT999">

    <link rel="icon" href="logo.avif" type="image/avif">

    <script>
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        // Handle PWA installation
        window.deferredPrompt = null;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            window.deferredPrompt = e;
            // Show install button or notification here if needed
        });
    </script>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>

    <style>
        body {
            font-family: sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #000000; /* Black background */
        }
        @keyframes pulse-result {
            0% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pulse-result {
            animation: pulse-result 0.5s ease-out forwards;
        }
        /* Adjusted animation for the rocket to give a more dynamic feel */
        @keyframes fly {
            0% { transform: translateX(-50%) translateY(50%) scale(1); opacity: 0.5; }
            25% { transform: translateX(0%) translateY(0%) scale(1.1); opacity: 0.7; }
            50% { transform: translateX(50%) translateY(-50%) scale(1.2); opacity: 1; }
            75% { transform: translateX(100%) translateY(-25%) scale(1.1); opacity: 0.7; }
            100% { transform: translateX(150%) translateY(0%) scale(1); opacity: 0.5; }
        }
        .animate-fly {
            animation: fly 2s ease-in-out infinite alternate; /* Looping animation */
        }
        /* Mines Game specific styles */
        .mines-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            width: 100%;
            max-width: 320px; /* Adjust grid size */
            margin: 0 auto;
        }
        .mine-box {
            width: 60px; /* Fixed size for boxes */
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            background-color: #374151; /* unopened - gray-700 */
            border: 2px solid #ca8a04; /* golden-700 */
            color: #fefce8; /* yellow-50 */
        }
        .mine-box:hover:not(.safe):not(.mine):not(.disabled-box) {
            transform: scale(1.05);
            background-color: #4b5563; /* gray-600 */
        }
        .mine-box.safe {
            background-color: #eab308; /* Golden for safe */
            color: black;
            border-color: #facc15;
        }
        .mine-box.mine {
            background-color: #1f2937; /* Dark gray for mine */
            color: white;
            border-color: #ef4444; /* red border for emphasis */
        }
        .mine-box.safe_revealed {
            background-color: #ca8a04; /* Darker Golden for revealed safe (unopened) */
            color: white;
            border-color: #eab308;
        }
        .mine-box.disabled-box {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .mine-box img {
            width: 80%; /* Make images fit inside the box */
            height: 80%;
            object-fit: contain;
        }

        /* Aviator video background styling */
        .aviator-video-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* Cover the entire container */
            z-index: 0; /* Behind other content */
            border-radius: 8px; /* Match container border-radius */
        }

        /* Loader styles */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loader-content {
            position: relative;
            width: 120px;
            height: 120px;
        }

        .loader-logo {
            width: 80px;
            height: 80px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            border: 4px solid #facc15; /* Golden border */
            overflow: hidden;
        }

        .loader-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .loader-ring {
            position: absolute;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid transparent;
            border-top-color: #facc15; /* Golden */
            animation: spin 1s linear infinite;
        }

        .loader-ring::before,
        .loader-ring::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            border: 4px solid transparent;
        }

        .loader-ring::before {
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            border-top-color: #eab308; /* Darker Golden */
            animation: spin 2s linear infinite;
        }

        .loader-ring::after {
            top: 15px;
            left: 15px;
            right: 15px;
            bottom: 15px;
            border-top-color: #ca8a04; /* Even Darker Golden */
            animation: spin 3s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loader-glow {
            position: absolute;
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(250, 204, 21, 0.2) 0%, rgba(250, 204, 21, 0) 70%);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCCgh6ML89ORBDOR7r4x8s79JvPjhLBTI8",
            authDomain: "bolt999-30e86.firebaseapp.com",
            projectId: "bolt999-30e86",
            storageBucket: "bolt999-30e86.firebasestorage.app",
            messagingSenderId: "627494404028",
            appId: "1:627494404028:web:af21c8bb1907093c7735b9"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Inlined SVG for Lucide icons for minimal requests
        const ArrowLeft = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>);
        const Coins = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-coins"><circle cx="8" cy="8" r="6"/><path d="M18.7 10.7H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H9.3a2 2 0 0 1-2-2V13a2 2 0 0 1 2-2h1.3"/><path d="M10 16H8"/></svg>);
        const TrendingUp = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-trending-up"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>);
        const History = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucude-history"><path d="M12 8v4l3 3"/><path d="M17.8 6.2c.7 5.1-1.6 9.8-6.1 11.3a5.5 5.5 0 0 1-7.8-7.6 5.5 5.5 0 0 1 7.6-7.8l1.6 1.6"/></svg>);
        const Gamepad = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-gamepad"><path d="M6 12H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-2"/><path d="M12 12v6a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-6"/><path d="M12 12H8a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h4"/></svg>);
        const Rocket = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-rocket"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5L2 22c0 0.5 0.5 1 1 1h.5c0 0-3-1.5-2.5-3.5C3.5 16.5 6 15 6 15l-1.5 1.5z"/><path d="M10 15h4l-1 6H9l1-6z"/><path d="M17.7 9.3l-1.3-1.3c-0.2-0.2-0.5-0.3-0.7-0.3c-0.3 0-0.5 0.1-0.7 0.3l-1.3 1.3c-0.4 0.4-0.4 1 0 1.4l1.3 1.3c0.2 0.2 0.5 0.3 0.7 0.3c0.3 0 0.5-0.1 0.7-0.3l1.3-1.3c0.4-0.4 0.4-1 0-1.4z"/><path d="M16 21v-4l-1.5-1.5"/><path d="M13 14V3l3 3l-3 3"/><path d="M15 12h5.5c.5 0 1 .5 1 1v.5c0 0-1.5 3-3.5 2.5S15 12 15 12z"/></svg>);
        const Bomb = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-bomb"><circle cx="12" cy="12" r="10"/><path d="m15.5 9.5-3 3-3-3"/><path d="m8.5 14.5 3-3 3 3"/></svg>);
        const Sparkles = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-sparkles"><path d="M12 20V10"/><path d="M19 12H5"/><path d="m12 21.5 3.5 2.5L12 17l-3.5 2.5z"/><path d="m22 2-2.5 2.5L17 2l2.5-2.5z"/><path d="m2 2 2.5 2.5L7 2l-2.5-2.5z"/></svg>);

        // Logo Component
        const Logo = ({ onClick }) => (
            <div 
                className="w-16 h-16 rounded-full overflow-hidden border-4 border-yellow-400 shadow-lg cursor-pointer hover:scale-105 transition-transform"
                onClick={onClick}
            >
                <img src="logo.avif" alt="Beast Earn Logo" className="w-full h-full object-cover" />
            </div>
        );

        // Guide Button Component
        const GuideButton = ({ audioFile }) => {
            const [audio] = React.useState(new Audio(audioFile));

            // Cleanup audio when component unmounts
            React.useEffect(() => {
                return () => {
                    audio.pause();
                    audio.currentTime = 0;
                };
            }, []);

            const playGuide = () => {
                audio.currentTime = 0; // Reset to start
                audio.play();
            };

            return (
                <button
                    onClick={playGuide}
                    className="px-3 py-1 bg-yellow-400 text-black rounded-lg font-bold hover:bg-yellow-500 transition-colors flex items-center gap-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 16v-4"/>
                        <path d="M12 8h.01"/>
                    </svg>
                    Guide
                </button>
            );
        };

        // --- Auth Components ---
        const LoginPage = ({ setAuthenticated, navigateToRegister }) => {
            const [error, setError] = React.useState('');

            const handleGoogleLogin = async () => {
                setError('');
                showLoader();
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    const result = await auth.signInWithPopup(provider);
                    
                    // Check if this is a new user
                    const userDoc = await db.collection('users').doc(result.user.uid).get();
                    
                    if (!userDoc.exists) {
                        // Create initial user document for new Google users
                        await db.collection('users').doc(result.user.uid).set({
                            email: result.user.email,
                            balance: 0,
                            gameHistory: [],
                            depositHistory: [],
                            withdrawHistory: [],
                            createdAt: new Date().toISOString()
                        });
                    }
                    
                    setAuthenticated(true);
                } catch (error) {
                    setError(error.message);
                }
            };

            return (
                <div className="max-w-md mx-auto bg-gradient-to-b from-black to-gray-900 min-h-screen text-white flex flex-col items-center justify-center p-4">
                    <GuideButton audioFile="auth.mp3" />
                    <Logo />
                    <h1 className="text-4xl font-extrabold mb-8 text-yellow-300 drop-shadow-lg">BOLT999</h1>
                    <h2 className="text-3xl font-bold mb-6">Login</h2>
                    <div className="bg-gray-800 bg-opacity-50 rounded-lg p-8 w-full max-w-sm">
                        {error && <p className="text-yellow-200 text-sm mb-4">{error}</p>}
                        <button
                            onClick={handleGoogleLogin}
                            className="w-full bg-white py-3 rounded-lg font-bold text-gray-800 hover:bg-gray-100 transition-colors mb-4 flex items-center justify-center"
                        >
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" className="w-6 h-6 mr-2" />
                            Continue with Google
                        </button>
                        <p className="text-center text-sm opacity-80">
                            Don't have an account? <button onClick={navigateToRegister} className="text-yellow-300 font-semibold hover:underline">Register here</button>
                        </p>
                    </div>
                </div>
            );
        };

        const RegisterPage = ({ setAuthenticated, navigateToLogin }) => {
            const [error, setError] = React.useState('');

            const handleGoogleLogin = async () => {
                setError('');
                showLoader();
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    const result = await auth.signInWithPopup(provider);
                    
                    // Check if this is a new user
                    const userDoc = await db.collection('users').doc(result.user.uid).get();
                    
                    if (!userDoc.exists) {
                        // Create initial user document for new Google users
                        await db.collection('users').doc(result.user.uid).set({
                            email: result.user.email,
                            balance: 0,
                            gameHistory: [],
                            depositHistory: [],
                            withdrawHistory: [],
                            createdAt: new Date().toISOString()
                        });
                    }
                    
                    setAuthenticated(true);
                } catch (error) {
                    setError(error.message);
                }
            };

            return (
                <div className="max-w-md mx-auto bg-gradient-to-b from-black to-gray-900 min-h-screen text-white flex flex-col items-center justify-center p-4">
                    <GuideButton audioFile="auth.mp3" />
                    <Logo />
                    <h1 className="text-4xl font-extrabold mb-8 text-yellow-300 drop-shadow-lg">BOLT999</h1>
                    <h2 className="text-3xl font-bold mb-6">Register</h2>
                    <div className="bg-gray-800 bg-opacity-50 rounded-lg p-8 w-full max-w-sm">
                        {error && <p className="text-yellow-200 text-sm mb-4">{error}</p>}
                        <button
                            onClick={handleGoogleLogin}
                            className="w-full bg-white py-3 rounded-lg font-bold text-gray-800 hover:bg-gray-100 transition-colors mb-4 flex items-center justify-center"
                        >
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" className="w-6 h-6 mr-2" />
                            Continue with Google
                        </button>
                        <p className="text-center text-sm opacity-80">
                            Already have an account? <button onClick={navigateToLogin} className="text-yellow-300 font-semibold hover:underline">Login here</button>
                        </p>
                    </div>
                </div>
            );
        };


        // --- History Page Component ---
        const HistoryPage = ({ navigateTo, gameHistory, depositHistory, withdrawHistory, initialTab = 'game' }) => {
            const [activeTab, setActiveTab] = React.useState(initialTab); // 'game', 'deposit', 'withdraw'

            React.useEffect(() => {
                setActiveTab(initialTab);
            }, [initialTab]);

            const getResultColor = (result) => {
                if (result === 0) return 'bg-gradient-to-r from-red-500 to-purple-500';
                if (result === 5) return 'bg-gradient-to-r from-yellow-500 to-purple-500';
                if (result % 2 === 0) return 'bg-red-500';
                return 'bg-yellow-500';
            };

            return (
                <div className="max-w-md mx-auto bg-gradient-to-b from-black to-gray-900 min-h-screen text-white p-4">
                    <div className="flex items-center gap-2 mb-6">
                        <button onClick={() => navigateTo('gameSelection')} className="p-2 rounded-full bg-gray-800 bg-opacity-50">
                            <ArrowLeft className="w-5 h-5 text-white" />
                        </button>
                        <Logo />
                        <h2 className="text-xl font-bold">Transaction History</h2>
                        <div className="ml-auto flex gap-2 items-center">
                            <GuideButton audioFile="history.mp3" />
                        </div>
                    </div>

                    <div className="flex bg-gray-800 bg-opacity-50 rounded-lg mb-4 p-1">
                        <button
                            className={`flex-1 py-2 text-sm font-semibold rounded-md ${activeTab === 'game' ? 'bg-yellow-400 text-black' : 'text-white'}`}
                            onClick={() => setActiveTab('game')}
                        >
                            Game
                        </button>
                        <button
                            className={`flex-1 py-2 text-sm font-semibold rounded-md ${activeTab === 'deposit' ? 'bg-yellow-400 text-black' : 'text-white'}`}
                            onClick={() => setActiveTab('deposit')}
                        >
                            Deposit
                        </button>
                        <button
                            className={`flex-1 py-2 text-sm font-semibold rounded-md ${activeTab === 'withdraw' ? 'bg-yellow-400 text-black' : 'text-white'}`}
                            onClick={() => setActiveTab('withdraw')}
                        >
                            Withdraw
                        </button>
                    </div>

                    <div className="bg-gray-800 bg-opacity-30 rounded-lg p-4">
                        {activeTab === 'game' && (
                            <div>
                                <h3 className="text-lg font-semibold mb-3">Game Play History</h3>
                                {gameHistory.length === 0 ? (
                                    <p className="text-center opacity-70">No game history yet.</p>
                                ) : (
                                    <div className="space-y-3 max-h-96 overflow-y-auto">
                                        {gameHistory.map((game, index) => (
                                            <div key={game.period} className="flex items-center justify-between bg-black bg-opacity-20 rounded-lg p-3">
                                                <div className="text-xs">{game.period}</div>
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold ${getResultColor(game.result)}`}>
                                                    {game.result}
                                                </div>
                                                <div className="text-sm">
                                                    {game.color ? (game.color.charAt(0).toUpperCase() + game.color.slice(1)) : ''} ({game.size})
                                                </div>
                                                {game.betOutcome && (
                                                    <div className={`font-bold ${game.betOutcome.type === 'win' ? 'text-green-400' : 'text-red-400'}`}>
                                                        {game.betOutcome.type === 'win' ? '+' : '-'}₹{game.betOutcome.amount.toFixed(2)}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'deposit' && (
                            <div>
                                <h3 className="text-lg font-semibold mb-3">Deposit History</h3>
                                {depositHistory.length === 0 ? (
                                    <p className="text-center opacity-70">No deposit history yet.</p>
                                ) : (
                                    <div className="space-y-3 max-h-96 overflow-y-auto">
                                        {depositHistory.map((deposit, index) => (
                                            <div key={index} className="flex items-center justify-between bg-black bg-opacity-20 rounded-lg p-3">
                                                <div className="flex items-center gap-2">
                                                    <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                                                    <div className="text-sm font-bold text-green-400">+ ₹{deposit.amount.toFixed(2)}</div>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <div className="text-xs opacity-80 truncate">{deposit.utr}</div>
                                                    <div className="text-xs bg-green-500 bg-opacity-20 text-green-300 px-2 py-1 rounded">Completed</div>
                                                </div>
                                                <div className="text-xs opacity-70">{new Date(deposit.timestamp).toLocaleString()}</div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'withdraw' && (
                            <div>
                                <h3 className="text-lg font-semibold mb-3">Withdrawal History</h3>
                                {withdrawHistory.length === 0 ? (
                                    <p className="text-center opacity-70">No withdrawal history yet.</p>
                                ) : (
                                    <div className="space-y-3 max-h-96 overflow-y-auto">
                                        {withdrawHistory.map((withdraw, index) => {
                                            // Calculate if 10 hours have passed since withdrawal
                                            const withdrawTime = new Date(withdraw.timestamp);
                                            const currentTime = new Date();
                                            const timeDiff = (currentTime - withdrawTime) / (1000 * 60 * 60); // Convert to hours
                                            const isCompleted = timeDiff >= 10;

                                            return (
                                                <div key={index} className="flex items-center justify-between bg-black bg-opacity-20 rounded-lg p-3">
                                                    <div className="flex items-center gap-2">
                                                        <div className={`w-2 h-2 rounded-full ${isCompleted ? 'bg-green-500' : 'bg-yellow-500'}`}></div>
                                                        <div className="text-sm font-bold text-red-400">- ₹{withdraw.amount.toFixed(2)}</div>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <div className="text-xs opacity-80 truncate">{withdraw.upiId}</div>
                                                        <div className={`text-xs px-2 py-1 rounded ${
                                                            isCompleted 
                                                                ? 'bg-green-500 bg-opacity-20 text-green-300' 
                                                                : 'bg-yellow-500 bg-opacity-20 text-yellow-300'
                                                        }`}>
                                                            {isCompleted ? 'Completed' : 'Pending'}
                                                        </div>
                                                    </div>
                                                    <div className="text-xs opacity-70">{new Date(withdraw.timestamp).toLocaleString()}</div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };


        // --- Deposit Page Component ---
        const DepositPage = ({ setBalance, navigateTo, addDepositToHistory, onError }) => {
            const [depositAmount, setDepositAmount] = React.useState('');
            const [utrNumber, setUtrNumber] = React.useState('');
            const [paymentScreenshot, setPaymentScreenshot] = React.useState(null);
            const [message, setMessage] = React.useState(null);
            const [lastUploadTime, setLastUploadTime] = React.useState(null);
            const [isVerifying, setIsVerifying] = React.useState(false);
            const upiId = "8979873681@mbk";
            const upiQrCodeUrl = "qr.png";

            const depositAmounts = [200, 500, 1000, 2000, 5000, 10000];
            const MIN_DEPOSIT_AMOUNT = 200;

            // Function to verify payment screenshot
            const verifyPaymentScreenshot = async (file) => {
                setIsVerifying(true);
                try {
                    // Check file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        throw new Error('Screenshot size should be less than 5MB. Please compress the image if needed.');
                    }

                    // Create a canvas to process the image
                    const img = new Image();
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Load image and process it
                    await new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = reject;
                        img.src = URL.createObjectURL(file);
                    });

                    // Check image dimensions (must be reasonable for a screenshot)
                    if (img.width < 200 || img.height < 200 || img.width > 4000 || img.height > 4000) {
                        throw new Error('Invalid screenshot dimensions. Please take a proper screenshot of your payment confirmation.');
                    }

                    // Set canvas size to match image
                    canvas.width = img.width;
                    canvas.height = img.height;

                    // Draw image on canvas
                    ctx.drawImage(img, 0, 0);

                    // Check for screenshot indicators
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const hasScreenshotIndicators = checkScreenshotIndicators(imageData);
                    if (!hasScreenshotIndicators) {
                        throw new Error('This doesn\'t appear to be a valid screenshot. Please take a proper screenshot of your payment confirmation.');
                    }

                    // Enhance image for better OCR
                    const enhancedData = enhanceImageForOCR(imageData);
                    ctx.putImageData(enhancedData, 0, 0);

                    // Use Tesseract with improved configuration
                    const result = await Tesseract.recognize(
                        canvas,
                        'eng',
                        {
                            logger: m => console.log(m),
                            tessedit_char_whitelist: '0123456789@.₹RsINRUPIabcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ',
                            tessedit_pageseg_mode: '6', // Assume uniform text orientation
                            tessjs_create_pdf: '0',
                            tessjs_create_hocr: '0',
                            tessjs_create_tsv: '0',
                            tessjs_create_box: '0',
                            tessjs_create_unlv: '0',
                            tessjs_create_osd: '0'
                        }
                    );

                    // Extract and normalize text
                    const text = result.data.text.toLowerCase()
                        .replace(/\s+/g, ' ')
                        .replace(/[^\w\s@₹.]/g, '')
                        .trim();

                    console.log('Extracted text:', text); // For debugging

                    // Verify UPI ID with multiple patterns and fuzzy matching
                    const upiPatterns = [
                        upiId.toLowerCase(),
                        upiId.toLowerCase().replace('@', ' @'),
                        upiId.toLowerCase().replace('@', ' @ '),
                        upiId.toLowerCase().replace('@', ' @mbk'),
                        'upi id: ' + upiId.toLowerCase(),
                        'upi: ' + upiId.toLowerCase(),
                        'paid to: ' + upiId.toLowerCase(),
                        'beneficiary: ' + upiId.toLowerCase(),
                        'upi id ' + upiId.toLowerCase(),
                        'upi ' + upiId.toLowerCase(),
                        'to ' + upiId.toLowerCase(),
                        'recipient: ' + upiId.toLowerCase(),
                        'receiver: ' + upiId.toLowerCase(),
                        // Add more variations for common UPI apps
                        'paytm: ' + upiId.toLowerCase(),
                        'google pay: ' + upiId.toLowerCase(),
                        'phonepe: ' + upiId.toLowerCase(),
                        'amazon pay: ' + upiId.toLowerCase(),
                        'bhim: ' + upiId.toLowerCase()
                    ];

                    const upiIdFound = upiPatterns.some(pattern => {
                        const normalizedPattern = pattern.toLowerCase().replace(/\s+/g, '');
                        const normalizedText = text.replace(/\s+/g, '');
                        return normalizedText.includes(normalizedPattern);
                    });

                    if (!upiIdFound) {
                        throw new Error('UPI ID verification failed. Please make sure the screenshot clearly shows payment to 8979873681@mbk. The UPI ID must be clearly visible in the payment confirmation.');
                    }

                    // Extract amount using multiple patterns with enhanced matching
                    const amountPatterns = [
                        /(?:rs\.?|inr|₹)\s*(\d+(?:\.\d{2})?)/i,
                        /amount\s*:?\s*(?:rs\.?|inr|₹)?\s*(\d+(?:\.\d{2})?)/i,
                        /paid\s*:?\s*(?:rs\.?|inr|₹)?\s*(\d+(?:\.\d{2})?)/i,
                        /total\s*:?\s*(?:rs\.?|inr|₹)?\s*(\d+(?:\.\d{2})?)/i,
                        /debit\s*:?\s*(?:rs\.?|inr|₹)?\s*(\d+(?:\.\d{2})?)/i,
                        /sent\s*:?\s*(?:rs\.?|inr|₹)?\s*(\d+(?:\.\d{2})?)/i,
                        /transfer\s*:?\s*(?:rs\.?|inr|₹)?\s*(\d+(?:\.\d{2})?)/i,
                        // Add more patterns for different UPI apps
                        /(?:paytm|google pay|phonepe|amazon pay|bhim)\s*(?:amount|paid|total)\s*:?\s*(?:rs\.?|inr|₹)?\s*(\d+(?:\.\d{2})?)/i
                    ];

                    let verifiedAmount = null;
                    for (const pattern of amountPatterns) {
                        const match = text.match(pattern);
                        if (match) {
                            verifiedAmount = parseFloat(match[1]);
                            break;
                        }
                    }

                    if (!verifiedAmount) {
                        throw new Error('Could not verify payment amount in the screenshot. Please ensure the amount is clearly visible in the payment confirmation.');
                    }

                    const userAmount = parseFloat(depositAmount);

                    // Verify amount matches with tolerance
                    if (Math.abs(verifiedAmount - userAmount) > 0.01) {
                        throw new Error(`Payment amount mismatch. Found ₹${verifiedAmount} in screenshot but you selected ₹${userAmount}. Please ensure you\'re uploading the correct payment confirmation.`);
                    }

                    // Enhanced timestamp verification
                    const currentTime = new Date();
                    const fileTime = new Date(file.lastModified);
                    const timeDifference = (currentTime - fileTime) / 1000; // Convert to seconds

                    // Check if screenshot is too old
                    if (timeDifference > 60) {
                        throw new Error('Screenshot is too old. Please take a fresh screenshot within 1 minute of payment completion.');
                    }

                    // Check if screenshot is from future (indicating wrong device time)
                    if (fileTime > currentTime) {
                        throw new Error('Invalid screenshot timestamp. Please check your device time settings and try again.');
                    }

                    // Check if screenshot is from a different date
                    if (fileTime.getDate() !== currentTime.getDate() || 
                        fileTime.getMonth() !== currentTime.getMonth() || 
                        fileTime.getFullYear() !== currentTime.getFullYear()) {
                        throw new Error('Screenshot must be from today\'s date. Please take a fresh screenshot of your payment confirmation.');
                    }

                    // Additional verification for payment status with enhanced patterns
                    const successPatterns = [
                        'successful',
                        'success',
                        'paid',
                        'completed',
                        'transaction successful',
                        'payment successful',
                        'payment completed',
                        'transaction completed',
                        'money sent',
                        'transfer successful',
                        'transfer completed',
                        // Add more patterns for different UPI apps
                        'payment done',
                        'payment processed',
                        'transaction done',
                        'transfer done',
                        'sent successfully',
                        'paid successfully',
                        'completed successfully'
                    ];

                    const hasSuccessIndicator = successPatterns.some(pattern => text.includes(pattern));
                    if (!hasSuccessIndicator) {
                        throw new Error('Could not verify successful payment status in the screenshot. Please ensure the payment status (successful/completed) is clearly visible in the confirmation.');
                    }

                    // Check for transaction ID/UTR in the screenshot
                    const transactionPatterns = [
                        /(?:transaction|txn|utr|reference)(?:\s*(?:id|number|no|#))?\s*:?\s*([A-Za-z0-9]{8,})/i,
                        /(?:upi|payment)(?:\s*(?:id|number|no|#))?\s*:?\s*([A-Za-z0-9]{8,})/i
                    ];

                    const hasTransactionId = transactionPatterns.some(pattern => text.match(pattern));
                    if (!hasTransactionId) {
                        throw new Error('Could not find transaction ID/UTR in the screenshot. Please ensure the transaction reference number is visible in the payment confirmation.');
                    }

                    return true;
                } catch (error) {
                    throw error;
                } finally {
                    setIsVerifying(false);
                }
            };

            // Function to check for screenshot indicators
            const checkScreenshotIndicators = (imageData) => {
                const data = imageData.data;
                let hasStatusBar = false;
                let hasTimeIndicator = false;
                let hasBatteryIndicator = false;
                let hasSignalIndicator = false;

                // Check for common screenshot indicators
                for (let i = 0; i < data.length; i += 4) {
                    // Check for status bar (usually at the top of screenshots)
                    if (i < imageData.width * 4 * 50) { // Check top 50 pixels
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        // Status bar usually has specific colors
                        if (r === 0 && g === 0 && b === 0) {
                            hasStatusBar = true;
                        }
                    }

                    // Check for time indicator (usually in status bar)
                    if (i < imageData.width * 4 * 30) { // Check top 30 pixels
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        // Time indicator usually has specific colors
                        if (r === 255 && g === 255 && b === 255) {
                            hasTimeIndicator = true;
                        }
                    }

                    // Check for battery indicator
                    if (i < imageData.width * 4 * 40) { // Check top 40 pixels
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        // Battery indicator usually has specific colors
                        if (r === 0 && g === 255 && b === 0) {
                            hasBatteryIndicator = true;
                        }
                    }

                    // Check for signal indicator
                    if (i < imageData.width * 4 * 40) { // Check top 40 pixels
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        // Signal indicator usually has specific colors
                        if (r === 255 && g === 255 && b === 255) {
                            hasSignalIndicator = true;
                        }
                    }
                }

                // Return true if at least two indicators are found
                return (hasStatusBar && hasTimeIndicator) || (hasBatteryIndicator && hasSignalIndicator);
            };

            // Function to enhance image for better OCR
            const enhanceImageForOCR = (imageData) => {
                const data = imageData.data;
                for (let i = 0; i < data.length; i += 4) {
                    // Convert to grayscale
                    const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    
                    // Increase contrast
                    const threshold = 128;
                    const newValue = avg > threshold ? 255 : 0;
                    
                    data[i] = newValue;     // R
                    data[i + 1] = newValue; // G
                    data[i + 2] = newValue; // B
                }
                return imageData;
            };

            // Function to check if the uploaded file is a valid screenshot
            const isScreenshot = async (file) => {
                // Check file type - only accept PNG
                if (file.type !== 'image/png') {
                    onError(); // Play error sound for invalid file type
                    setMessage({ 
                        type: 'error', 
                        text: '⚠️ Only PNG screenshots are accepted.' 
                    });
                    return false;
                }

                // Check if screenshot is within 60 seconds
                const currentTime = new Date();
                const fileTime = new Date(file.lastModified);
                const timeDifference = (currentTime - fileTime) / 1000; // Convert to seconds

                if (timeDifference > 60) {
                    onError();
                    setMessage({
                        type: 'error',
                        text: '⚠️ Screenshot is too old. Please take a fresh screenshot within 60 seconds of payment completion.'
                    });
                    return false;
                }

                // Check if screenshot is from a different date
                if (fileTime.getDate() !== currentTime.getDate() || 
                    fileTime.getMonth() !== currentTime.getMonth() || 
                    fileTime.getFullYear() !== currentTime.getFullYear()) {
                    onError();
                    setMessage({
                        type: 'error',
                        text: '⚠️ Screenshot must be from today\'s date.'
                    });
                    return false;
                }

                return true;
            };

            const handleFileChange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    setMessage(null); // Clear previous messages when a new file is selected
                    if (await isScreenshot(file)) {
                        setPaymentScreenshot(file);
                        // Additional verification is done on confirm button click, not just file selection
                    } else {
                        setPaymentScreenshot(null);
                    }
                }
            };

            const generateUpiLink = () => {
                const amount = parseFloat(depositAmount);
                if (isNaN(amount) || amount < MIN_DEPOSIT_AMOUNT) {
                    onError(); // Play error sound for invalid amount
                    setMessage({ type: 'error', text: `Please select a valid amount (minimum ₹${MIN_DEPOSIT_AMOUNT}).` });
                    return null;
                }
                const encodedUpiId = encodeURIComponent(upiId);
                const encodedAmount = encodeURIComponent(amount.toFixed(2));
                const encodedPayeeName = encodeURIComponent("Beast Earn Deposit");
                const encodedTransactionRef = encodeURIComponent(`BEASTEARN_${Date.now()}`);
                const encodedNote = encodeURIComponent("Deposit for Color Prediction Game");

                return `upi://pay?pa=${encodedUpiId}&pn=${encodedPayeeName}&mc=0000&tid=${encodedTransactionRef}&tr=${encodedTransactionRef}&am=${encodedAmount}&cu=INR&tn=${encodedNote}`;
            };

            const handlePayRedirect = () => {
                const upiLink = generateUpiLink();
                if (upiLink) {
                    window.location.href = upiLink;
                    setMessage({ type: 'info', text: 'Redirecting to UPI app... Please complete payment there.' });
                }
            };

            const handleManualConfirmation = () => {
                const amount = parseFloat(depositAmount);
                setMessage(null);

                if (isNaN(amount) || amount < MIN_DEPOSIT_AMOUNT) {
                    onError(); // Play error sound for invalid amount
                    setMessage({ type: 'error', text: `Please select a valid amount (minimum ₹${MIN_DEPOSIT_AMOUNT}).` });
                    return;
                }
                if (!utrNumber || utrNumber.length < 12) {
                    onError(); // Play error sound for invalid UTR
                    setMessage({ type: 'error', text: 'Please enter a valid UTR/Transaction ID (min 12 characters).' });
                    return;
                }
                if (!paymentScreenshot) {
                    onError(); // Play error sound for missing screenshot
                    setMessage({ type: 'error', text: 'Please upload a valid payment screenshot.' });
                    return;
                }
                if (!isScreenshot(paymentScreenshot)) {
                    onError(); // Play error sound for invalid screenshot
                    setMessage({ type: 'error', text: 'Please upload a valid payment screenshot. Other image types are not accepted.' });
                    return;
                }

                setBalance(prev => prev + amount);
                addDepositToHistory({
                    amount: amount,
                    utr: utrNumber,
                    timestamp: new Date().toISOString()
                });
                setMessage({ type: 'success', text: `₹${amount.toFixed(2)} added to your balance with UTR: ${utrNumber}!` });
                setDepositAmount('');
                setUtrNumber('');
                setPaymentScreenshot(null);
                setTimeout(() => {
                    setMessage(null);
                    navigateTo('gameSelection');
                }, 2500);
            };

            return (
                <div className="max-w-md mx-auto bg-gradient-to-b from-black to-gray-900 min-h-screen text-white p-4">
                    <div className="flex items-center gap-2 mb-6">
                        <button onClick={() => navigateTo('gameSelection')} className="p-2 rounded-full bg-gray-800 bg-opacity-50">
                            <ArrowLeft className="w-5 h-5 text-white" />
                        </button>
                        <Logo />
                        <h2 className="text-xl font-bold">Deposit</h2>
                        <div className="ml-auto flex gap-2 items-center">
                            <button
                                onClick={() => navigateTo('history', { initialTab: 'deposit' })}
                                className="px-3 py-1 bg-gray-800 bg-opacity-50 rounded-lg text-sm font-semibold hover:bg-gray-700 transition-colors"
                            >
                                History
                            </button>
                            <GuideButton audioFile="deposite.mp3" />
                        </div>
                    </div>

                    <div className="bg-gray-800 bg-opacity-50 rounded-lg p-6 mb-4">
                        {upiQrCodeUrl && (
                            <div className="mb-4 text-center">
                                <p className="text-sm font-semibold mb-2">Scan QR to Pay</p>
                                <img src={upiQrCodeUrl} alt="UPI QR Code" className="w-40 h-40 mx-auto bg-white p-2 rounded-lg" />
                                <p className="text-sm mt-2">UPI ID: <span className="font-bold text-yellow-300">{upiId}</span></p>
                            </div>
                        )}

                        <label className="block text-sm font-semibold mb-2">Select Amount (₹)</label>
                        <div className="grid grid-cols-3 gap-2 mb-4">
                            {depositAmounts.map((amount) => (
                                <button
                                    key={amount}
                                    onClick={() => setDepositAmount(amount.toString())}
                                    className={`p-3 rounded-lg font-bold transition-colors ${
                                        depositAmount === amount.toString()
                                            ? 'bg-yellow-400 text-black'
                                            : 'bg-gray-700 bg-opacity-50 text-white hover:bg-gray-600'
                                    }`}
                                >
                                    ₹{amount}
                                </button>
                            ))}
                        </div>

                        <button
                            onClick={handlePayRedirect}
                            className="w-full bg-yellow-400 py-3 rounded-lg font-bold text-black hover:bg-yellow-500 transition-colors mb-3"
                        >
                            Pay to Deposit
                        </button>

                        <hr className="border-t border-gray-700 my-4" />

                        <label htmlFor="utr-number" className="block text-sm font-semibold mb-2">Enter UTR / Transaction ID</label>
                        <input
                            id="utr-number"
                            type="text"
                            value={utrNumber}
                            onChange={(e) => setUtrNumber(e.target.value)}
                            className="w-full p-3 rounded-lg bg-gray-200 text-gray-900 mb-4 focus:outline-none focus:ring-2 focus:ring-yellow-400"
                            placeholder="e.g., 401234567890"
                        />

                        {/* Screenshot Input with verification status */}
                        <label htmlFor="payment-screenshot" className="block text-sm font-semibold mb-2">
                            Upload Payment Screenshot
                            {isVerifying && (
                                <span className="ml-2 text-yellow-300">
                                    <span className="animate-pulse">Verifying...</span>
                                </span>
                            )}
                        </label>
                        <input
                            id="payment-screenshot"
                            type="file"
                            accept="image/png"
                            onChange={handleFileChange}
                            className="w-full text-sm text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-400 file:text-black hover:file:bg-yellow-500 mb-4"
                        />
                        {paymentScreenshot && (
                            <div className="text-sm text-green-300 mb-4">
                                <p>File selected: {paymentScreenshot.name}</p>
                                <p className="text-xs opacity-80">Size: {(paymentScreenshot.size / 1024).toFixed(1)}KB</p>
                            </div>
                        )}

                        <button
                            onClick={handleManualConfirmation}
                            className="w-full bg-yellow-400 py-3 rounded-lg font-bold text-black hover:bg-yellow-500 transition-colors"
                        >
                            Confirm Payment (I have Paid)
                        </button>

                        {message && (
                            <div className={`mt-4 p-3 rounded-lg text-center ${
                                message.type === 'success' ? 'bg-green-200 text-green-800' :
                                message.type === 'error' ? 'bg-red-200 text-red-800' :
                                'bg-yellow-200 text-yellow-800'
                            }`}>
                                {message.text}
                            </div>
                        )}
                    </div>

                    <div className="bg-gray-800 bg-opacity-30 rounded-lg p-4">
                        <h3 className="text-lg font-semibold mb-2 text-yellow-300">Deposit Instructions:</h3>
                        <ul className="text-sm list-disc pl-5 space-y-2 text-gray-300">
                            <li>Select the amount you wish to deposit from the available options.</li>
                            <li>Scan the QR code or click **"Pay to Deposit"** to open your UPI app.</li>
                            <li>Complete the payment using your preferred UPI app to the UPI ID: <span className="font-bold text-yellow-300">{upiId}</span></li>
                            <li>**IMPORTANT**: After successful payment, take a screenshot of your payment confirmation.</li>
                            <li>The screenshot must clearly show:</li>
                            <ul className="list-disc pl-5 mt-1 space-y-1">
                                <li>The payment amount</li>
                                <li>The UPI ID (8979873681@mbk)</li>
                                <li>Payment status (successful/completed)</li>
                                <li>Current date and time</li>
                            </ul>
                            <li>Enter the **UTR/Transaction ID** from your UPI app.</li>
                            <li>**Note**: Only PNG images taken within the last 60 seconds are accepted.</li>
                            <li>Maximum file size: 5MB</li>
                            <li>Click **"Confirm Payment (I have Paid)"** to add the amount to your balance.</li>
                            <li>Your balance will update immediately after all required information is submitted.</li>
                            <li>Available deposit amounts: ₹10, ₹20, ₹50, ₹100, ₹200, ₹500, ₹1000, ₹2000, ₹5000</li>
                        </ul>
                    </div>
                </div>
            );
        };

        // --- Withdraw Page Component ---
        const WithdrawPage = ({ balance, setBalance, navigateTo, addWithdrawToHistory, onError }) => {
            const [withdrawAmount, setWithdrawAmount] = React.useState('');
            const [upiIdInput, setUpiIdInput] = React.useState('');
            const [message, setMessage] = React.useState(null);
            const formRef = React.useRef(null);

            const MIN_WITHDRAW_AMOUNT = 200;
            const withdrawAmounts = [200, 500, 1000, 2000];

            const handleWithdraw = async () => {
                const amount = parseFloat(withdrawAmount);
                if (isNaN(amount) || amount < MIN_WITHDRAW_AMOUNT) {
                    onError(); // Play error sound for invalid amount
                    setMessage({ type: 'error', text: `Please select a valid amount (minimum ₹${MIN_WITHDRAW_AMOUNT}).` });
                    return;
                }
                if (!upiIdInput) {
                    onError(); // Play error sound for missing UPI ID
                    setMessage({ type: 'error', text: 'Please enter your UPI ID.' });
                    return;
                }
                if (amount > balance) {
                    onError(); // Play error sound for insufficient balance
                    setMessage({ type: 'error', text: 'Insufficient balance!' });
                    return;
                }

                setBalance(prev => prev - amount);
                addWithdrawToHistory({
                    amount: amount,
                    upiId: upiIdInput,
                    timestamp: new Date().toISOString()
                });

                const formData = new FormData(formRef.current);
                formData.set('Withdrawal Amount', `₹${amount.toFixed(2)}`);
                formData.set('UPI ID', upiIdInput);
                formData.set('Timestamp', new Date().toLocaleString());

                try {
                    const response = await fetch("https://formspree.io/f/mqaqanbg", {
                        method: "POST",
                        body: formData,
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (response.ok) {
                        setMessage({ type: 'success', text: `Withdrawal request for ₹${amount.toFixed(2)} submitted! You will receive funds shortly.` });
                        setWithdrawAmount('');
                        setUpiIdInput('');
                    } else {
                        onError(); // Play error sound for failed request
                        setMessage({ type: 'error', text: 'Failed to send withdrawal request. Please try again.' });
                    }
                } catch (error) {
                    onError(); // Play error sound for network error
                    console.error('Formspree submission error:', error);
                    setMessage({ type: 'error', text: 'An error occurred. Please check console.' });
                }

                setTimeout(() => {
                    setMessage(null);
                    navigateTo('gameSelection');
                }, 3000);
            };

            return (
                <div className="max-w-md mx-auto bg-gradient-to-b from-black to-gray-900 min-h-screen text-white p-4">
                    <div className="flex items-center gap-2 mb-6">
                        <button onClick={() => navigateTo('gameSelection')} className="p-2 rounded-full bg-gray-800 bg-opacity-50">
                            <ArrowLeft className="w-5 h-5 text-white" />
                        </button>
                        <Logo />
                        <h2 className="text-xl font-bold">Withdraw</h2>
                        <div className="ml-auto flex gap-2 items-center">
                            <button
                                onClick={() => navigateTo('history', { initialTab: 'withdraw' })}
                                className="px-3 py-1 bg-gray-800 bg-opacity-50 rounded-lg text-sm font-semibold hover:bg-gray-700 transition-colors"
                            >
                                History
                            </button>
                            <GuideButton audioFile="withdraw.mp3" />
                        </div>
                    </div>

                    <div className="bg-gray-800 bg-opacity-50 rounded-lg p-6 mb-4">
                        <div className="text-center mb-4">
                            <div className="text-xl font-bold">Current Balance: <span className="text-yellow-300">₹{balance.toFixed(2)}</span></div>
                        </div>
                        <label className="block text-sm font-semibold mb-2">Select Amount (₹)</label>
                        <div className="grid grid-cols-2 gap-2 mb-4">
                            {withdrawAmounts.map((amount) => (
                                <button
                                    key={amount}
                                    onClick={() => setWithdrawAmount(amount.toString())}
                                    className={`p-3 rounded-lg font-bold transition-colors ${
                                        withdrawAmount === amount.toString()
                                            ? 'bg-yellow-400 text-black'
                                            : 'bg-gray-700 bg-opacity-50 text-white hover:bg-gray-600'
                                    }`}
                                >
                                    ₹{amount}
                                </button>
                            ))}
                        </div>
                        <label htmlFor="upi-id" className="block text-sm font-semibold mb-2">Your UPI ID</label>
                        <input
                            id="upi-id"
                            type="text"
                            value={upiIdInput}
                            onChange={(e) => setUpiIdInput(e.target.value)}
                            className="w-full p-3 rounded-lg bg-gray-200 text-gray-900 mb-4 focus:outline-none focus:ring-2 focus:ring-yellow-400"
                            placeholder="e.g., yourname@bankupi"
                        />
                        <button
                            onClick={handleWithdraw}
                            className="w-full bg-yellow-400 py-3 rounded-lg font-bold text-black hover:bg-yellow-500 transition-colors"
                        >
                            Withdraw
                        </button>

                        {message && (
                            <div className={`mt-4 p-3 rounded-lg text-center ${
                                message.type === 'success' ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'
                            }`}>
                                {message.text}
                            </div>
                        )}

                        <form ref={formRef} action="https://formspree.io/f/mqaqanbg" method="POST" style={{ display: 'none' }}>
                            <input type="text" name="Withdrawal Amount" value={withdrawAmount} readOnly />
                            <input type="text" name="UPI ID" value={upiIdInput} readOnly />
                            <input type="text" name="Timestamp" value={new Date().toLocaleString()} readOnly />
                        </form>
                    </div>

                    <div className="bg-gray-800 bg-opacity-30 rounded-lg p-4">
                        <h3 className="text-lg font-semibold mb-2 text-yellow-300">Withdrawal Instructions:</h3>
                        <ul className="text-sm list-disc pl-5 space-y-2 text-gray-300">
                            <li>Select the amount you wish to withdraw (₹200, ₹500, ₹1000, or ₹2000).</li>
                            <li>Enter your valid UPI ID where you want to receive the funds.</li>
                            <li>Click the **"Withdraw"** button.</li>
                            <li>Your balance will be deducted immediately.</li>
                            <li>A withdrawal request will be sent to our team. Please allow up to 24 hours for processing.</li>
                            <li>Ensure your UPI ID is correct to avoid delays.</li>
                        </ul>
                    </div>
                </div>
            );
        };


        const ColorPredictionGame = ({ balance, setBalance, navigateTo, gameHistory, setGameHistory, addDepositToHistory, addWithdrawToHistory, currentUser, updateUserData }) => {
            const [currentPeriod, setCurrentPeriod] = React.useState(1); // Default to 1
            const [timeLeft, setTimeLeft] = React.useState(0);
            const [gameState, setGameState] = React.useState('betting');
            const [selectedColor, setSelectedColor] = React.useState(null);
            const [betAmount, setBetAmount] = React.useState(10);
            const [customBetAmount, setCustomBetAmount] = React.useState('');

            const [currentResult, setCurrentResult] = React.useState(null);
            const [showResult, setShowResult] = React.useState(false);
            const [victoryMessage, setVictoryMessage] = React.useState(null);

            const colors = ['Gold', 'Violet', 'Red'];
            const numbers = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
            const betSizes = ['Big', 'Small'];

            // Fetch the user's last period from Firestore on component mount
            React.useEffect(() => {
                if (currentUser) {
                    db.collection('users').doc(currentUser.uid).get().then((doc) => {
                        if (doc.exists && doc.data().lastPeriod) {
                            setCurrentPeriod(doc.data().lastPeriod + 1);
                        }
                    });
                }
            }, [currentUser]);

            React.useEffect(() => {
                let interval;
                if (gameState === 'running' && timeLeft > 0) {
                    interval = setInterval(() => {
                        setTimeLeft((prev) => {
                            if (prev <= 1) {
                                setGameState('result');
                                generateResult();
                                return 0;
                            }
                            return prev - 1;
                        });
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [gameState, timeLeft]);

            const generateResult = () => {
                const resultNumber = Math.floor(Math.random() * 10);
                let resultColor = 'gold';

                if (resultNumber === 0) resultColor = 'red-violet';
                else if (resultNumber === 5) resultColor = 'gold-violet';
                else if (resultNumber % 2 === 0) resultColor = 'red';
                else resultColor = 'gold';

                const resultSize = resultNumber < 5 ? 'Small' : 'Big';

                const newResult = {
                    period: currentPeriod,
                    result: resultNumber,
                    color: resultColor,
                    size: resultSize,
                    betOutcome: null // To store outcome for history
                };

                setCurrentResult(newResult);
                setShowResult(true);

                if (selectedColor) {
                    const outcome = calculateWinnings(newResult);
                    newResult.betOutcome = outcome; // Store outcome with result
                }

                setTimeout(() => {
                    setGameHistory(prev => [newResult, ...prev]); // Add new result to history
                    setShowResult(false);
                    setCurrentResult(null);
                    setSelectedColor(null);
                    setGameState('betting');
                    setCurrentPeriod(prev => prev + 1); // Increment period by 1
                    setCustomBetAmount(''); // Clear custom bet input

                    // Update the user's lastPeriod in Firestore
                    if (currentUser) {
                        updateUserData({ lastPeriod: currentPeriod });
                    }
                }, 3000);
            };

            const calculateWinnings = (result) => {
                let won = false;
                let multiplier = 0;
                let outcome = { type: 'loss', amount: betAmount }; // Default to loss

                if (selectedColor === 'Gold' && (result.color === 'gold' || result.color === 'gold-violet')) {
                    won = true;
                    multiplier = 1.96;
                } else if (selectedColor === 'Red' && (result.color === 'red' || result.color === 'red-violet')) {
                    won = true;
                    multiplier = 1.96;
                } else if (selectedColor === 'Violet' && (result.color === 'red-violet' || result.color === 'gold-violet')) {
                    won = true;
                    multiplier = 3;
                } else if (typeof selectedColor === 'number' && selectedColor === result.result) {
                    won = true;
                    multiplier = 8.50;
                } else if (selectedColor === 'Big' && result.size === 'Big') {
                    won = true;
                    multiplier = 1.96;
                } else if (selectedColor === 'Small' && result.size === 'Small') {
                    won = true;
                    multiplier = 1.96;
                }

                if (won) {
                    const winAmount = (betAmount * multiplier);
                    setBalance(prev => prev + winAmount);
                    outcome = { type: 'win', amount: winAmount };
                    setVictoryMessage({
                        type: 'win',
                        amount: winAmount,
                        message: '🎉 Congratulations! You Won! 🎉'
                    });
                } else {
                    setVictoryMessage({
                        type: 'loss',
                        amount: betAmount,
                        message: '😔 Better Luck Next Time! 😔'
                    });
                }

                setTimeout(() => {
                    setVictoryMessage(null);
                }, 2500);

                return outcome;
            };

            const placeBet = (selection) => {
                let finalBetAmount = betAmount;
                if (customBetAmount !== '') {
                    const parsedCustomAmount = parseFloat(customBetAmount);
                    if (!isNaN(parsedCustomAmount) && parsedCustomAmount > 0) {
                        finalBetAmount = parsedCustomAmount;
                    } else {
                        alert("Please enter a valid custom bet amount or select from options.");
                        return;
                    }
                }

                if (gameState !== 'betting' || balance < finalBetAmount) {
                    if (balance < finalBetAmount) {
                        alert("Insufficient balance to place this bet!");
                    } else {
                        alert("Betting is currently closed.");
                    }
                    return;
                }

                // Deduct bet amount immediately
                setBalance(prev => prev - finalBetAmount);
                setBetAmount(finalBetAmount);
                setSelectedColor(selection);
                setGameState('running');
                setTimeLeft(12);
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            };

            const getResultColor = (result) => {
                if (result === 0) return 'bg-gradient-to-r from-red-500 to-purple-500';
                if (result === 5) return 'bg-gradient-to-r from-yellow-500 to-purple-500';
                if (result % 2 === 0) return 'bg-red-500';
                return 'bg-yellow-500';
            };

            const getColorButtonStyle = (color) => {
                const baseStyle = "flex-1 py-3 rounded-lg font-semibold text-black transition-all duration-200 ";
                if (color === 'Gold') return baseStyle + "bg-yellow-400 hover:bg-yellow-500";
                if (color === 'Violet') return baseStyle + "bg-purple-500 hover:bg-purple-600 text-white";
                if (color === 'Red') return baseStyle + "bg-red-500 hover:bg-red-600 text-white";
                return baseStyle;
            };

            const handleCustomBetAmountChange = (e) => {
                const value = e.target.value;
                setCustomBetAmount(value);
                if (value === '' || parseFloat(value) <= 0) {
                    setBetAmount(10); 
                } else {
                    setBetAmount(parseFloat(value));
                }
            };

            return (
                <div className="max-w-md mx-auto bg-gradient-to-b from-black to-gray-900 min-h-screen text-white">
                    {/* Header */}
                    <div className="flex items-center justify-between p-4 bg-black">
                        <div className="flex items-center gap-2">
                            <button onClick={() => navigateTo('gameSelection')} className="p-2 rounded-full bg-gray-800 bg-opacity-50">
                                <ArrowLeft className="w-5 h-5 text-white" />
                            </button>
                            <Logo />
                            <span className="font-bold text-yellow-300">BOLT999</span>
                        </div>
                        <div className="flex gap-2 items-center">
                            <button
                                onClick={() => navigateTo('history')}
                                className="px-3 py-1 bg-gray-800 bg-opacity-50 rounded-lg text-sm font-semibold hover:bg-gray-700 transition-colors"
                            >
                                History
                            </button>
                            <GuideButton audioFile="color.mp3" />
                        </div>
                    </div>

                    {/* Balance */}
                    <div className="bg-gray-800 bg-opacity-30 rounded-lg m-4 p-4 text-center">
                        <div className="text-2xl font-bold text-yellow-300">₹{balance.toFixed(2)}</div>
                        <div className="text-sm opacity-80">Wallet balance</div>
                        <div className="flex gap-2 mt-3">
                            <button
                                className="flex-1 bg-red-600 py-2 rounded-lg font-bold"
                                onClick={() => navigateTo('withdraw')}
                            >
                                Withdraw
                            </button>
                            <button
                                className="flex-1 bg-green-600 py-2 rounded-lg font-bold"
                                onClick={() => navigateTo('deposit')}
                            >
                                Deposit
                            </button>
                        </div>
                    </div>

                    {/* Game Info */}
                    <div className="px-4 mb-4">
                        <div className="bg-gray-800 bg-opacity-30 rounded-lg p-3">
                            {gameState === 'running' && selectedColor !== null && (
                                <div className="flex items-center gap-2 mb-2">
                                    <div className="w-4 h-4 bg-yellow-400 rounded"></div>
                                    <span className="text-sm">
                                        Your Bet: <span className="font-bold">{typeof selectedColor === 'number' ? selectedColor : selectedColor}</span>
                                        {' '}(₹{betAmount.toFixed(2)}
                                        {selectedColor !== 'Violet' && typeof selectedColor !== 'number' && ' x1.96'}
                                        {selectedColor === 'Violet' && ' x3'}
                                        {typeof selectedColor === 'number' && ' x8.5'}
                                        )
                                    </span>
                                </div>
                            )}

                            <div className="flex justify-between items-center bg-black bg-opacity-20 rounded-lg p-3 mt-2">
                                <div>
                                    <div className="text-xs opacity-80">Time Remaining</div>
                                    <div className="text-2xl font-bold text-yellow-300">
                                        {gameState === 'betting' ? '∞' : formatTime(timeLeft)}
                                    </div>
                                </div>
                                <div className="text-right">
                                    <div className="text-xs opacity-80">Period</div>
                                    <div className="text-sm">{currentPeriod}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Result Display */}
                    {showResult && currentResult && (
                        <div className="mx-4 mb-4 bg-gray-800 bg-opacity-40 rounded-lg p-4 text-center">
                            <div className="text-lg font-bold mb-2">Result</div>
                            <div className={`w-16 h-16 rounded-full mx-auto flex items-center justify-center text-2xl font-bold animate-pulse-result ${getResultColor(currentResult.result)}`}>
                                {currentResult.result}
                            </div>
                            <div className="mt-2 text-sm">{currentResult.size}</div>
                        </div>
                    )}

                    {/* Color Betting */}
                    <div className="px-4 mb-4">
                        <div className="flex gap-2 mb-3">
                            {colors.map((color) => (
                                <button
                                    key={color}
                                    onClick={() => placeBet(color)}
                                    disabled={gameState !== 'betting'}
                                    className={`${getColorButtonStyle(color)} ${
                                        selectedColor === color ? 'ring-2 ring-white' : ''
                                    } disabled:opacity-50`}
                                >
                                    {color}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Number Betting */}
                    <div className="px-4 mb-4">
                        <div className="grid grid-cols-5 gap-2">
                            {numbers.map((num) => (
                                <button
                                    key={num}
                                    onClick={() => placeBet(num)}
                                    disabled={gameState !== 'betting'}
                                    className={`w-12 h-12 rounded-full flex items-center justify-center font-bold border-2 border-gray-600 ${
                                        getResultColor(num)
                                    } ${selectedColor === num ? 'ring-2 ring-yellow-400' : ''} disabled:opacity-50`}
                                >
                                    {num}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Bet Amount */}
                    <div className="px-4 mb-4">
                        <label htmlFor="custom-bet-amount" className="block text-sm font-semibold mb-2">Bet Amount (₹)</label>
                        <div className="flex items-center gap-2 mb-2">
                            <div className="flex gap-1">
                                {[10, 100, 1000].map((amount) => (
                                    <button
                                        key={amount}
                                        onClick={() => { setBetAmount(amount); setCustomBetAmount(''); }}
                                        className={`px-3 py-1 rounded text-xs ${
                                            betAmount === amount && customBetAmount === '' ? 'bg-yellow-400 text-black' : 'bg-gray-700 text-white'
                                        }`}
                                    >
                                        {amount}
                                    </button>
                                ))}
                            </div>
                            <input
                                id="custom-bet-amount"
                                type="number"
                                value={customBetAmount}
                                onChange={handleCustomBetAmountChange}
                                className="flex-1 p-2 rounded-lg text-gray-900 bg-gray-200 focus:outline-none focus:ring-2 focus:ring-yellow-400 min-w-0"
                                placeholder="Custom"
                                min="1"
                            />
                        </div>
                    </div>

                    {/* Size Betting */}
                    <div className="px-4 mb-4">
                        <div className="flex gap-2">
                            {betSizes.map((size) => (
                                <button
                                    key={size}
                                    onClick={() => placeBet(size)}
                                    disabled={gameState !== 'betting'}
                                    className={`flex-1 py-3 rounded-lg font-semibold text-white ${
                                        size === 'Big' ? 'bg-orange-500' : 'bg-blue-500'
                                    } ${selectedColor === size ? 'ring-2 ring-white' : ''} disabled:opacity-50`}
                                >
                                    {size}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Game History (Only showing last 3) */}
                    <div className="px-4 mb-4">
                        <div className="bg-gray-800 bg-opacity-30 rounded-lg p-3">
                            <div className="flex items-center gap-2 mb-3">
                                <History className="w-4 h-4" />
                                <span className="text-sm font-semibold">Recent Game History</span>
                            </div>

                            <div className="space-y-2">
                                {gameHistory.slice(0, 3).map((game, index) => (
                                    <div key={game.period} className="flex items-center justify-between bg-black bg-opacity-20 rounded p-2">
                                        <div className="text-xs">{game.period}</div>
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${getResultColor(game.result)}`}>
                                            {game.result}
                                        </div>
                                        <div className="text-xs">{game.size}</div>
                                        <div className="flex gap-1">
                                            <div className="w-2 h-2 bg-yellow-400 rounded-full"></div>
                                            <div className="w-2 h-2 bg-red-400 rounded-full"></div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* History Button */}
                    <div className="px-4 pb-4">
                        <button
                            onClick={() => navigateTo('history')}
                            className="w-full bg-yellow-400 py-3 rounded-lg font-bold text-black hover:bg-yellow-500 transition-colors"
                        >
                            View All History
                        </button>
                    </div>

                    {/* Victory/Loss Message */}
                    {victoryMessage && (
                        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
                            <div className={`bg-gray-800 rounded-2xl p-8 text-center mx-4 transform animate-pulse ${
                                victoryMessage.type === 'win' ? 'border-4 border-yellow-400' : 'border-4 border-red-400'
                            }`}>
                                <div className={`text-2xl font-bold mb-4 ${
                                    victoryMessage.type === 'win' ? 'text-yellow-400' : 'text-red-400'
                                }`}>
                                    {victoryMessage.message}
                                </div>
                                <div className={`text-3xl font-bold mb-2 ${
                                    victoryMessage.type === 'win' ? 'text-green-400' : 'text-red-500'
                                }`}>
                                    {victoryMessage.type === 'win' ? '+' : '-'}₹{victoryMessage.amount.toFixed(2)}
                                </div>
                                <div className="text-gray-400 text-sm">
                                    {victoryMessage.type === 'win' ? 'Added to your balance' : 'Deducted from your balance'}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Game Status */}
                    {gameState !== 'betting' && (
                        <div className="fixed bottom-4 left-4 right-4 bg-black bg-opacity-80 rounded-lg p-3 text-center text-yellow-300">
                            <div className="text-sm">
                                {gameState === 'running' ? 'Betting Closed - Game Running...' : 'Calculating Results...'}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Mines Game Component ---
        const MinesGame = ({ balance, setBalance, navigateTo }) => {
            const [betAmount, setBetAmount] = React.useState(10);
            const [customBetAmount, setCustomBetAmount] = React.useState('');
            const [grid, setGrid] = React.useState([]);
            const [minesPositions, setMinesPositions] = React.useState([]);
            const [safeOpenedCount, setSafeOpenedCount] = React.useState(0);
            const [currentMultiplier, setCurrentMultiplier] = React.useState(1.00);
            const [potentialWinnings, setPotentialWinnings] = React.useState(0);
            const [isGameActive, setIsGameActive] = React.useState(false);
            const [message, setMessage] = React.useState('');

            // Create audio objects
            const coinSound = new Audio('coin.mp3');
            const boomSound = new Audio('boom.mp3');
            const cashoutSound = new Audio('dw.mp3');

            // Cleanup audio when component unmounts
            React.useEffect(() => {
                return () => {
                    coinSound.pause();
                    coinSound.currentTime = 0;
                    boomSound.pause();
                    boomSound.currentTime = 0;
                    cashoutSound.pause();
                    cashoutSound.currentTime = 0;
                };
            }, []);

            const NUM_BOXES = 25;
            const NUM_MINES = 5;

            // Function to generate the grid and place mines randomly
            const generateGrid = () => {
                let newGrid = Array.from({ length: NUM_BOXES }, (_, i) => ({ id: i, status: 'unopened', value: null }));
                let mines = new Set();
                while (mines.size < NUM_MINES) {
                    mines.add(Math.floor(Math.random() * NUM_BOXES));
                }
                const newMinesPositions = Array.from(mines);
                setMinesPositions(newMinesPositions);

                newGrid = newGrid.map((box) => {
                    if (newMinesPositions.includes(box.id)) {
                        return { ...box, value: 'mine' };
                    }
                    return { ...box, value: 'safe' };
                });
                setGrid(newGrid);
            };

            // Function to calculate the multiplier based on safe boxes opened
            const calculateNextMultiplier = (openedSafes) => {
                return parseFloat((1 + openedSafes * 0.15).toFixed(2));
            };

            // Function to start a new game round
            const startGame = () => {
                const finalBetAmount = customBetAmount !== '' ? parseFloat(customBetAmount) : betAmount;
                if (isNaN(finalBetAmount) || finalBetAmount <= 0) {
                    setMessage("Please enter a valid bet amount.");
                    return;
                }
                if (finalBetAmount > balance) {
                    setMessage("Insufficient balance.");
                    return;
                }

                setBalance(prev => prev - finalBetAmount); // Deduct bet from balance
                setBetAmount(finalBetAmount);
                setSafeOpenedCount(0);
                setCurrentMultiplier(1.00);
                setPotentialWinnings(0);
                setIsGameActive(true);
                setMessage('Game started! Click a box.');
                generateGrid(); // Generate a new grid for the game
            };

            // Handler for clicking a box on the grid
            const handleBoxClick = (index) => {
                if (!isGameActive || grid[index].status !== 'unopened') return;

                const newGrid = [...grid];
                const clickedBox = newGrid[index];

                if (clickedBox.value === 'mine') {
                    // Player hit a mine
                    clickedBox.status = 'mine';
                    setIsGameActive(false);
                    setMessage(`BOOM! You hit a mine. You lost ₹${betAmount.toFixed(2)}.`);
                    boomSound.currentTime = 0;
                    boomSound.play().catch(error => console.log('Error playing boom sound:', error));
                    revealAllBoxes(newGrid);
                    setTimeout(resetGame, 3000);
                } else {
                    // Player opened a safe box
                    clickedBox.status = 'safe';
                    const newSafeOpenedCount = safeOpenedCount + 1;
                    setSafeOpenedCount(newSafeOpenedCount);

                    const nextMultiplier = calculateNextMultiplier(newSafeOpenedCount);
                    setCurrentMultiplier(nextMultiplier);
                    setPotentialWinnings(parseFloat((betAmount * nextMultiplier).toFixed(2)));
                    setMessage(`Safe! Current Multiplier: x${nextMultiplier.toFixed(2)}`);
                    
                    // Play coin sound for safe box
                    coinSound.currentTime = 0;
                    coinSound.play().catch(error => console.log('Error playing coin sound:', error));

                    if (newSafeOpenedCount === NUM_BOXES - NUM_MINES) {
                        handleCashOut(newGrid);
                    }
                }
                setGrid(newGrid);
            };

            // Function to reveal all boxes (mines and unopened safes) at game end
            const revealAllBoxes = (currentGrid) => {
                const revealedGrid = currentGrid.map(box => {
                    if (box.value === 'mine') return { ...box, status: 'mine' };
                    if (box.value === 'safe' && box.status === 'unopened') return { ...box, status: 'safe_revealed' }; // Show unopened safes
                    return box;
                });
                setGrid(revealedGrid);
            };

            // Function to cash out winnings
            const handleCashOut = (gridOnCashOut = grid) => {
                if (!isGameActive || safeOpenedCount === 0) {
                    setMessage("Open at least one safe box to cash out.");
                    return;
                }

                setIsGameActive(false);
                setBalance(prev => prev + potentialWinnings);
                setMessage(`Cashed out x${currentMultiplier.toFixed(2)}! You won ₹${potentialWinnings.toFixed(2)}!`);
                
                // Play cashout sound
                cashoutSound.currentTime = 0;
                cashoutSound.play().catch(error => console.log('Error playing cashout sound:', error));
                
                revealAllBoxes(gridOnCashOut);
                setTimeout(resetGame, 3000);
            };

            // Function to reset game state for a new round
            const resetGame = () => {
                setBetAmount(10); // Reset bet amount input to default
                setCustomBetAmount(''); // Clear custom bet input
                setGrid([]);
                setMinesPositions([]);
                setSafeOpenedCount(0);
                setCurrentMultiplier(1.00);
                setPotentialWinnings(0);
                setIsGameActive(false);
                setMessage('');
            };

            return (
                <div className="max-w-md mx-auto bg-gradient-to-b from-black to-gray-900 min-h-screen text-white p-4 flex flex-col">
                    {/* Header */}
                    <div className="flex items-center gap-2 mb-6">
                        <button onClick={() => navigateTo('gameSelection')} className="p-2 rounded-full bg-gray-800 bg-opacity-50">
                            <ArrowLeft className="w-5 h-5 text-white" />
                        </button>
                        <Logo />
                        <h2 className="text-xl font-bold text-yellow-300">Mines</h2>
                        <div className="ml-auto flex gap-2 items-center">
                            <button
                                onClick={() => navigateTo('history')}
                                className="px-3 py-1 bg-gray-800 bg-opacity-50 rounded-lg text-sm font-semibold hover:bg-gray-700 transition-colors"
                            >
                                History
                            </button>
                            <GuideButton audioFile="mine.mp3" />
                        </div>
                    </div>

                    {/* Wallet Balance Display */}
                    <div className="bg-gray-800 bg-opacity-30 rounded-lg p-4 text-center mb-4">
                        <div className="text-2xl font-bold text-yellow-300">₹{balance.toFixed(2)}</div>
                        <div className="text-sm opacity-80">Wallet balance</div>
                        <div className="flex gap-2 mt-3">
                            <button
                                className="flex-1 bg-red-600 py-2 rounded-lg font-bold"
                                onClick={() => navigateTo('withdraw')}
                            >
                                Withdraw
                            </button>
                            <button
                                className="flex-1 bg-green-600 py-2 rounded-lg font-bold"
                                onClick={() => navigateTo('deposit')}
                            >
                                Deposit
                            </button>
                        </div>
                    </div>

                    {/* Game Controls - Bet Amount */}
                    <div className="bg-gray-800 bg-opacity-30 rounded-lg p-6 mb-4">
                        <div className="mb-4">
                            <label htmlFor="mines-bet-amount" className="block text-sm font-semibold mb-2">Bet Amount (₹)</label>
                            <div className="flex items-center gap-2">
                                <div className="flex gap-1">
                                    {[10, 50, 100].map((amount) => (
                                        <button
                                            key={amount}
                                            onClick={() => { setBetAmount(amount); setCustomBetAmount(''); }}
                                            className={`px-3 py-1 rounded text-xs ${
                                                (betAmount === amount && customBetAmount === '') && !isGameActive ? 'bg-yellow-400 text-black' : 'bg-gray-700 text-white'
                                            } hover:bg-yellow-500 transition-colors`}
                                            disabled={isGameActive}
                                        >
                                            {amount}
                                        </button>
                                    ))}
                                </div>
                                <input
                                    id="mines-bet-amount"
                                    type="number"
                                    value={customBetAmount}
                                    onChange={(e) => setCustomBetAmount(e.target.value)}
                                    className="flex-1 p-2 rounded-lg text-gray-900 bg-gray-200 focus:outline-none focus:ring-2 focus:ring-yellow-400 min-w-0"
                                    placeholder="Custom"
                                    min="1"
                                    disabled={isGameActive}
                                />
                            </div>
                        </div>
                        {message && (
                            <div className={`mt-4 p-3 rounded-lg text-center ${
                                message.includes('won') || message.includes('Cashed out') ? 'bg-green-200 text-green-800' :
                                message.includes('lost') || message.includes('BOOM') ? 'bg-red-200 text-red-800' :
                                'bg-blue-200 text-blue-800'
                            }`}>
                                {message}
                            </div>
                        )}
                    </div>

                    {/* Mines Grid */}
                    <div className="mines-grid mb-4">
                        {grid.map((box) => (
                            <div
                                key={box.id}
                                className={`mine-box ${box.status} ${!isGameActive && box.value === 'mine' ? 'mine' : ''} ${!isGameActive && box.status === 'safe_revealed' ? 'safe_revealed' : ''} ${!isGameActive && box.status === 'unopened' ? 'disabled-box' : ''}`}
                                onClick={() => handleBoxClick(box.id)}
                            >
                                {box.status === 'mine' && <img src="boom.png" alt="Mine" onError={(e)=>{e.target.onerror = null; e.target.src='https://placehold.co/48x48/1F2937/FFFFFF?text=X'}} />}
                                {box.status === 'safe' && <img src="coin.png" alt="Coin" onError={(e)=>{e.target.onerror = null; e.target.src='https://placehold.co/48x48/eab308/000000?text=O'}} />}
                                {box.status === 'safe_revealed' && <img src="coin.png" alt="Coin" onError={(e)=>{e.target.onerror = null; e.target.src='https://placehold.co/48x48/ca8a04/FFFFFF?text=O'}} />}
                            </div>
                        ))}
                    </div>

                    {/* Game Status / Multiplier / Winnings & Action Buttons */}
                    <div className="bg-gray-800 bg-opacity-30 rounded-lg p-6">
                        {!isGameActive ? (
                            <button
                                onClick={startGame}
                                className="w-full bg-green-600 py-3 rounded-lg font-bold text-white hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled={isNaN(parseFloat(customBetAmount !== '' ? customBetAmount : betAmount)) || parseFloat(customBetAmount !== '' ? customBetAmount : betAmount) <= 0 || (customBetAmount !== '' ? parseFloat(customBetAmount) : betAmount) > balance}
                            >
                                START GAME
                            </button>
                        ) : (
                            <>
                                <div className="flex justify-between items-center my-4 text-center">
                                    <div>
                                        <div className="text-sm opacity-80">Current Multiplier</div>
                                        <div className="text-2xl font-bold text-yellow-300">x{currentMultiplier.toFixed(2)}</div>
                                    </div>
                                    <div>
                                        <div className="text-sm opacity-80">Potential Winnings</div>
                                        <div className="text-2xl font-bold text-green-400">₹{potentialWinnings.toFixed(2)}</div>
                                    </div>
                                </div>
                                <button
                                    onClick={handleCashOut}
                                    className="w-full bg-yellow-400 py-3 rounded-lg font-bold text-black hover:bg-yellow-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                    disabled={safeOpenedCount === 0}
                                >
                                    CASH OUT (₹{potentialWinnings.toFixed(2)})
                                </button>
                            </>
                        )}
                    </div>
                </div>
            );
        };


        // --- Game Selection Page ---
        const GameSelectionPage = ({ balance, navigateTo, handleLogout }) => {
            const [showMessage, setShowMessage] = React.useState(false);
            const [messageText, setMessageText] = React.useState('');

            const handleGameClick = (gameType) => {
                if (balance < 1) {
                    setMessageText(`Your balance is ₹${balance.toFixed(2)}. Keep at least ₹1 in your balance to enter in game.`);
                    setShowMessage(true);
                    setTimeout(() => setShowMessage(false), 3000);
                } else {
                    navigateTo(gameType);
                }
            };

            return (
                <div className="max-w-md mx-auto bg-gradient-to-b from-black to-gray-900 min-h-screen text-white p-4">
                    {/* Header */}
                    <div className="flex items-center justify-between p-4 bg-black -mx-4 -mt-4 rounded-b-lg shadow-lg shadow-yellow-400/10">
                        <div className="flex items-center gap-2">
                            <Logo onClick={() => navigateTo('profile')} />
                            <span className="font-bold text-yellow-300">BOLT999</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <GuideButton audioFile="main.mp3" />
                            <button
                                onClick={handleLogout}
                                className="px-3 py-1 bg-gray-800 bg-opacity-50 rounded-lg text-sm font-semibold hover:bg-gray-700 transition-colors"
                            >
                                Logout
                            </button>
                        </div>
                    </div>

                    {/* Balance Card */}
                    <div className="bg-gray-800 bg-opacity-30 rounded-lg m-4 p-4 text-center border border-yellow-400/30">
                        <div className="text-2xl font-bold text-yellow-300">₹{balance.toFixed(2)}</div>
                        <div className="text-sm opacity-80">Wallet balance</div>
                        <div className="flex gap-2 mt-3">
                            <button
                                className="flex-1 bg-red-600 py-2 rounded-lg font-bold"
                                onClick={() => navigateTo('withdraw')}
                            >
                                Withdraw
                            </button>
                            <button
                                className="flex-1 bg-green-600 py-2 rounded-lg font-bold"
                                onClick={() => navigateTo('deposit')}
                            >
                                Deposit
                            </button>
                        </div>
                    </div>

                    <h2 className="text-2xl font-bold text-center mb-6 text-yellow-300">Select a Game</h2>

                    {/* Message Component */}
                    {showMessage && (
                        <div className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-yellow-400 text-gray-900 px-6 py-4 rounded-lg shadow-lg z-50 text-center max-w-[90%]">
                            {messageText}
                        </div>
                    )}

                    <div className="grid grid-cols-1 gap-4 px-4 mb-20">
                        <div
                            className="bg-gray-800 bg-opacity-30 rounded-lg p-6 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-gray-700 transition-all border border-yellow-400/30"
                            onClick={() => handleGameClick('colorPrediction')}
                        >
                            <img src="color.png" alt="Color Prediction Game Icon" className="w-24 h-24 rounded-full object-cover mb-4 border-2 border-yellow-400" onError={(e)=>{e.target.onerror = null; e.target.src='https://placehold.co/96x96/FFD700/000000?text=Color'}} />
                            <h3 className="text-xl font-bold mb-2 text-yellow-400">Color Prediction</h3>
                            <p className="text-sm opacity-80">Predict the next color and win!</p>
                        </div>

                        <div
                            className="bg-gray-800 bg-opacity-30 rounded-lg p-6 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-gray-700 transition-all border border-yellow-400/30"
                            onClick={() => handleGameClick('mines')}
                        >
                            <img src="mine.png" alt="Mine Game Icon" className="w-24 h-24 rounded-full object-cover mb-4 border-2 border-yellow-400" onError={(e)=>{e.target.onerror = null; e.target.src='https://placehold.co/96x96/FFD700/000000?text=Mine'}} />
                            <h3 className="text-xl font-bold mb-2 text-yellow-400">Mine</h3>
                            <p className="text-sm opacity-80">Uncover treasures, avoid mines!</p>
                        </div>
                    </div>

                    {/* App Download and Share App Buttons */}
                    <div className="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black to-transparent z-50">
                        <div className="max-w-md mx-auto flex gap-4">
                            {/* App Download Button */}
                            <div className="flex-1 md:hidden">
                                <button
                                    onClick={() => {
                                        if (window.matchMedia('(display-mode: standalone)').matches) {
                                            const message = document.createElement('div');
                                            message.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-yellow-400 text-black px-6 py-3 rounded-lg shadow-lg z-50 text-center';
                                            message.textContent = 'App is already installed!';
                                            document.body.appendChild(message);
                                            setTimeout(() => document.body.removeChild(message), 3000);
                                        } else if ('standalone' in navigator && !navigator.standalone) {
                                            alert('To install the app on your device:\n1. Tap the Share button\n2. Scroll down and tap "Add to Home Screen"');
                                        } else {
                                            if (window.deferredPrompt) {
                                                window.deferredPrompt.prompt();
                                                window.deferredPrompt.userChoice.then((choiceResult) => {
                                                    if (choiceResult.outcome === 'accepted') {
                                                        const successMessage = document.createElement('div');
                                                        successMessage.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 text-center';
                                                        successMessage.textContent = 'App installed in your device!';
                                                        document.body.appendChild(successMessage);
                                                        setTimeout(() => document.body.removeChild(successMessage), 3000);
                                                    }
                                                    window.deferredPrompt = null;
                                                });
                                            } else {
                                                alert('To install the app:\n1. Open this website in Chrome\n2. Tap the menu (three dots)\n3. Select "Install app" or "Add to Home screen"');
                                            }
                                        }
                                    }}
                                    className="w-full bg-yellow-400 text-black py-3 rounded-lg font-bold hover:bg-yellow-500 transition-colors"
                                >
                                    App Download
                                </button>
                            </div>
                            {/* Share App Button */}
                            <button
                                onClick={() => {
                                    if (navigator.share) {
                                        navigator.share({
                                            title: 'Beast Earn App',
                                            text: 'Check out this amazing gaming app!',
                                            url: 'https://beastmanxxx.github.io/Beast-Earn-App/'
                                        }).catch(console.error);
                                    } else {
                                        const dummy = document.createElement('input');
                                        document.body.appendChild(dummy);
                                        dummy.value = 'https://beastmanxxx.github.io/Beast-Earn-App/';
                                        dummy.select();
                                        document.execCommand('copy');
                                        document.body.removeChild(dummy);
                                        alert('Link copied to clipboard! Share it with your friends.');
                                    }
                                }}
                                className={`${window.matchMedia('(min-width: 768px)').matches ? 'w-full' : 'flex-1'} bg-green-500 py-3 rounded-lg font-bold hover:bg-green-600 transition-colors`}
                            >
                                Share App
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Profile Page Component
        const ProfilePage = ({ navigateTo, currentUser, updateUserData, setBalance }) => {
            const [userName, setUserName] = React.useState('');
            const [isEditing, setIsEditing] = React.useState(false);
            const [message, setMessage] = React.useState(null);
            const [giftCode, setGiftCode] = React.useState('');
            const [lastRedeemTime, setLastRedeemTime] = React.useState(null);

            // Load user data when component mounts
            React.useEffect(() => {
                if (currentUser) {
                    db.collection('users').doc(currentUser.uid).get().then((doc) => {
                        if (doc.exists) {
                            const userData = doc.data();
                            setUserName(userData.userName || '');
                            setLastRedeemTime(userData.lastGiftCodeRedeemTime || null);
                        }
                    });
                }
            }, [currentUser]);

            const handleSaveName = async () => {
                if (userName.trim().length < 3) {
                    setMessage({ type: 'error', text: 'Name must be at least 3 characters long' });
                    return;
                }

                try {
                    await updateUserData({ userName });
                    setIsEditing(false);
                    setMessage({ type: 'success', text: 'Profile updated successfully!' });
                    setTimeout(() => setMessage(null), 3000);
                } catch (error) {
                    setMessage({ type: 'error', text: 'Failed to update profile' });
                }
            };

            const handleRedeemGiftCode = async () => {
                if (!giftCode.trim()) {
                    setMessage({ type: 'error', text: 'Please enter a gift code' });
                    return;
                }

                // Check if 24 hours have passed since last redemption
                if (lastRedeemTime) {
                    const lastRedeem = new Date(lastRedeemTime);
                    const now = new Date();
                    const hoursDiff = (now - lastRedeem) / (1000 * 60 * 60);
                    
                    if (hoursDiff < 24) {
                        const remainingHours = Math.ceil(24 - hoursDiff);
                        setMessage({ 
                            type: 'error', 
                            text: `You can redeem a gift code again in ${remainingHours} hours` 
                        });
                        return;
                    }
                }

                if (giftCode.toLowerCase() === 'you10') {
                    try {
                        // Update balance
                        setBalance(prev => prev + 10);
                        
                        // Update last redeem time
                        const currentTime = new Date().toISOString();
                        await updateUserData({ lastGiftCodeRedeemTime: currentTime });
                        setLastRedeemTime(currentTime);
                        
                        setMessage({ 
                            type: 'success', 
                            text: 'Gift code redeemed successfully! ₹10 added to your balance.' 
                        });
                        setGiftCode('');
                    } catch (error) {
                        setMessage({ type: 'error', text: 'Failed to redeem gift code' });
                    }
                } else {
                    setMessage({ type: 'error', text: 'Invalid gift code' });
                }
            };

            return (
                <div className="max-w-md mx-auto bg-gradient-to-b from-black to-gray-900 min-h-screen text-white p-4">
                    <div className="flex items-center gap-2 mb-6">
                        <button onClick={() => navigateTo('gameSelection')} className="p-2 rounded-full bg-gray-800 bg-opacity-50">
                            <ArrowLeft className="w-5 h-5 text-white" />
                        </button>
                        <Logo onClick={() => navigateTo('profile')} />
                        <h2 className="text-xl font-bold text-yellow-300">Profile</h2>
                    </div>

                    <div className="bg-gray-800 bg-opacity-30 rounded-lg p-6 mb-4">
                        <div className="flex flex-col items-center mb-6">
                            <div className="w-24 h-24 rounded-full overflow-hidden border-4 border-yellow-400 mb-4">
                                <img 
                                    src={currentUser?.photoURL || "https://ui-avatars.com/api/?name=" + encodeURIComponent(userName || currentUser?.email) + "&background=eab308&color=000"} 
                                    alt="Profile" 
                                    className="w-full h-full object-cover"
                                />
                            </div>
                            <div className="text-center">
                                <div className="text-sm opacity-80 mb-1">Email</div>
                                <div className="font-semibold">{currentUser?.email}</div>
                            </div>
                        </div>

                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-semibold mb-2">Your Name</label>
                                {isEditing ? (
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={userName}
                                            onChange={(e) => setUserName(e.target.value)}
                                            className="flex-1 p-3 rounded-lg bg-gray-200 text-gray-900 focus:outline-none focus:ring-2 focus:ring-yellow-400"
                                            placeholder="Enter your name"
                                        />
                                        <button
                                            onClick={handleSaveName}
                                            className="px-4 py-2 bg-yellow-400 text-black rounded-lg font-bold hover:bg-yellow-500 transition-colors"
                                        >
                                            Save
                                        </button>
                                    </div>
                                ) : (
                                    <div className="flex items-center justify-between bg-black bg-opacity-20 rounded-lg p-3">
                                        <div className="font-semibold">{userName || 'Not set'}</div>
                                        <button
                                            onClick={() => setIsEditing(true)}
                                            className="text-yellow-300 hover:text-yellow-400"
                                        >
                                            Edit
                                        </button>
                                    </div>
                                )}
                            </div>

                            {/* Gift Code Section */}
                            <div className="mt-6 pt-6 border-t border-gray-700">
                                <label className="block text-sm font-semibold mb-2">Redeem Gift Code</label>
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={giftCode}
                                        onChange={(e) => setGiftCode(e.target.value)}
                                        className="flex-1 p-3 rounded-lg bg-gray-200 text-gray-900 focus:outline-none focus:ring-2 focus:ring-yellow-400"
                                        placeholder="Enter gift code"
                                    />
                                    <button
                                        onClick={handleRedeemGiftCode}
                                        className="px-4 py-2 bg-yellow-400 text-black rounded-lg font-bold hover:bg-yellow-500 transition-colors"
                                    >
                                        Redeem
                                    </button>
                                </div>
                                <p className="text-xs opacity-70 mt-2">
                                    Enter Gift code to get ₹10. Can be redeemed once every 24 hours. You received gift code Daily on our instagram story. Join our Instagram.
                                </p>
                            </div>
                        </div>

                        {/* Telegram Join Button Section */}
                        <div className="mt-6 pt-6 border-t border-gray-700">
                            <label className="block text-sm font-semibold mb-2">Join Our Telegram</label>
                            <a 
                                href="https://t.me/beastearncolorpredictiongame" 
                                target="_blank" 
                                rel="noopener noreferrer"
                                className="flex items-center justify-center gap-2 w-full p-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-bold transition-colors"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69.01-.03.01-.14-.07-.2-.08-.06-.19-.04-.27-.02-.12.02-1.96 1.25-5.54 3.69-.52.36-1 .53-1.42.52-.47-.01-1.37-.26-2.03-.48-.82-.27-1.47-.42-1.42-.88.03-.25.38-.51 1.05-.78 4.12-1.79 6.87-2.97 8.26-3.54 3.93-1.63 4.75-1.91 5.26-1.91.12 0 .38.03.55.17.14.12.18.28.2.45-.02.05-.02.31-.02.31z"/>
                                </svg>
                                Join Telegram Channel
                            </a>
                            <p className="text-xs opacity-70 mt-2">
                                Join our Telegram channel to get daily updates, tips, and exclusive offers!
                            </p>
                        </div>

                        {message && (
                            <div className={`mt-4 p-3 rounded-lg text-center ${
                                message.type === 'success' ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'
                            }`}>
                                {message.text}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [authenticated, setAuthenticated] = React.useState(false);
            const [currentPage, setCurrentPage] = React.useState('login');
            const [showInstallMessage, setShowInstallMessage] = React.useState(false);
            const [navigationHistory, setNavigationHistory] = React.useState(['login']);

            // Handle PWA installation
            React.useEffect(() => {
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    window.deferredPrompt = e;
                });

                window.addEventListener('appinstalled', () => {
                    setShowInstallMessage(true);
                    setTimeout(() => {
                        setShowInstallMessage(false);
                    }, 3000);
                });
            }, []);

            // Handle Android back button
            React.useEffect(() => {
                const handleBackButton = async (event) => {
                    if (navigationHistory.length > 1) {
                        event.preventDefault();
                        await showLoader(); // Show loader before navigation
                        const newHistory = [...navigationHistory];
                        newHistory.pop(); // Remove current page
                        const previousPage = newHistory[newHistory.length - 1];
                        setNavigationHistory(newHistory);
                        setCurrentPage(previousPage);
                    }
                };

                window.addEventListener('popstate', handleBackButton);
                return () => window.removeEventListener('popstate', handleBackButton);
            }, [navigationHistory]);

            const navigateTo = async (page) => {
                await showLoader();
                setCurrentPage(page);
                setNavigationHistory(prev => [...prev, page]);
                // Add to browser history
                window.history.pushState({ page }, '', `#${page}`);
            };

            const [historyInitialTab, setHistoryInitialTab] = React.useState('game');
            const [currentUser, setCurrentUser] = React.useState(null);
            const [balance, setBalance] = React.useState(0);
            const [gameHistory, setGameHistory] = React.useState([]);
            const [depositHistory, setDepositHistory] = React.useState([]);
            const [withdrawHistory, setWithdrawHistory] = React.useState([]);

            // Function to play transaction success sound
            const playTransactionSound = () => {
                const audio = new Audio('dw.mp3');
                audio.play().catch(error => console.log('Error playing audio:', error));
            };

            // Function to play error sound
            const playErrorSound = () => {
                const audio = new Audio('error.mp3');
                audio.play().catch(error => console.log('Error playing audio:', error));
            };

            // Listen for auth state changes
            React.useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((user) => {
                    if (user) {
                        setCurrentUser(user);
                        setAuthenticated(true);
                        // Load user data from Firestore
                        loadUserData(user.uid);
                    } else {
                        setCurrentUser(null);
                        setAuthenticated(false);
                        setBalance(0);
                        setGameHistory([]);
                        setDepositHistory([]);
                        setWithdrawHistory([]);
                    }
                });

                return () => unsubscribe();
            }, []);

            // Function to load user data from Firestore
            const loadUserData = async (userId) => {
                try {
                    const userDoc = await db.collection('users').doc(userId).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        setBalance(userData.balance || 0);
                        setGameHistory(userData.gameHistory || []);
                        setDepositHistory(userData.depositHistory || []);
                        setWithdrawHistory(userData.withdrawHistory || []);
                    }
                } catch (error) {
                    console.error("Error loading user data:", error);
                }
            };

            // Function to update user data in Firestore
            const updateUserData = async (updates) => {
                if (!currentUser) return;
                
                try {
                    await db.collection('users').doc(currentUser.uid).update(updates);
                } catch (error) {
                    console.error("Error updating user data:", error);
                }
            };

            // Update Firestore when balance changes
            React.useEffect(() => {
                if (currentUser) {
                    updateUserData({ balance });
                }
            }, [balance]);

            // Update Firestore when game history changes
            React.useEffect(() => {
                if (currentUser) {
                    updateUserData({ gameHistory });
                }
            }, [gameHistory]);

            // Update Firestore when deposit history changes
            React.useEffect(() => {
                if (currentUser) {
                    updateUserData({ depositHistory });
                }
            }, [depositHistory]);

            // Update Firestore when withdraw history changes
            React.useEffect(() => {
                if (currentUser) {
                    updateUserData({ withdrawHistory });
                }
            }, [withdrawHistory]);

            // Handlers for state updates from child components
            const addDepositToHistory = (deposit) => {
                setDepositHistory(prev => [deposit, ...prev]);
                playTransactionSound(); // Play sound on successful deposit
            };

            const addWithdrawToHistory = (withdraw) => {
                setWithdrawHistory(prev => [withdraw, ...prev]);
                playTransactionSound(); // Play sound on successful withdrawal
            };

            const handleDepositError = () => {
                playErrorSound(); // Play error sound on deposit mistakes
            };

            const handleWithdrawError = () => {
                playErrorSound(); // Play error sound on withdrawal mistakes
            };

            const handleLogout = async () => {
                try {
                    await showLoader();
                    await auth.signOut();
                    setCurrentUser(null);
                    setAuthenticated(false);
                } catch (error) {
                    console.error("Error signing out:", error);
                }
            };

            if (!authenticated) {
                if (currentPage === 'login') {
                    return <LoginPage setAuthenticated={setAuthenticated} navigateToRegister={() => navigateTo('register')} />;
                } else {
                    return <RegisterPage setAuthenticated={setAuthenticated} navigateToLogin={() => navigateTo('login')} />;
                }
            }

            // Rest of your existing switch statement for rendering different pages
            switch (currentPage) {
                case 'gameSelection':
                    return <GameSelectionPage balance={balance} navigateTo={navigateTo} handleLogout={handleLogout} />;
                case 'colorPrediction':
                    return <ColorPredictionGame
                                balance={balance}
                                setBalance={setBalance}
                                navigateTo={navigateTo}
                                gameHistory={gameHistory}
                                setGameHistory={setGameHistory}
                                addDepositToHistory={addDepositToHistory}
                                addWithdrawToHistory={addWithdrawToHistory}
                                currentUser={currentUser}
                                updateUserData={updateUserData}
                            />;
                case 'deposit':
                    return <DepositPage 
                                setBalance={setBalance} 
                                navigateTo={navigateTo} 
                                addDepositToHistory={addDepositToHistory}
                                onError={handleDepositError}
                            />;
                case 'withdraw':
                    return <WithdrawPage 
                                balance={balance} 
                                setBalance={setBalance} 
                                navigateTo={navigateTo} 
                                addWithdrawToHistory={addWithdrawToHistory}
                                onError={handleWithdrawError}
                            />;
                case 'history':
                    return <HistoryPage navigateTo={navigateTo} gameHistory={gameHistory} depositHistory={depositHistory} withdrawHistory={withdrawHistory} initialTab={historyInitialTab} />;
                case 'mines':
                    return <MinesGame balance={balance} setBalance={setBalance} navigateTo={navigateTo} />;
                case 'profile':
                    return <ProfilePage 
                        navigateTo={navigateTo} 
                        currentUser={currentUser}
                        updateUserData={updateUserData}
                        setBalance={setBalance}
                    />;
                default:
                    return <GameSelectionPage balance={balance} navigateTo={navigateTo} handleLogout={handleLogout} />;
            }
        };

        // Loader Component
        const Loader = () => (
            <div className="loader-container">
                <div className="loader-content">
                    <div className="loader-glow"></div>
                    <div className="loader-ring"></div>
                    <div className="loader-logo">
                        <img src="logo.avif" alt="Loading..." />
                    </div>
                </div>
            </div>
        );

        // Function to show loader for 2 seconds
        const showLoader = () => {
            return new Promise((resolve) => {
                const loaderRoot = document.createElement('div');
                loaderRoot.id = 'loader-root';
                document.body.appendChild(loaderRoot);
                
                ReactDOM.render(<Loader />, loaderRoot);
                
                setTimeout(() => {
                    ReactDOM.unmountComponentAtNode(loaderRoot);
                    document.body.removeChild(loaderRoot);
                    resolve();
                }, 2000);
            });
        };

        // Preloader function
        const showPreloader = async () => {
            const loaderRoot = document.createElement('div');
            loaderRoot.id = 'loader-root';
            document.body.appendChild(loaderRoot);
            
            ReactDOM.render(<Loader />, loaderRoot);
            
            // Wait for 2 seconds
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Remove loader
            ReactDOM.unmountComponentAtNode(loaderRoot);
            document.body.removeChild(loaderRoot);
            
            // Render the main app
            ReactDOM.render(<App />, document.getElementById('root'));
        };

        // Start the app with preloader
        showPreloader();
    </script>
</body>
</html>
